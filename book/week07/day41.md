# Day 41: TCPä¸‰æ¬¡æ¡æ‰‹æ·±å…¥åˆ†æ

## ğŸ“š ä»Šæ—¥å¯¼è¯­

æ¬¢è¿æ¥åˆ°ç¬¬ä¸ƒå‘¨çš„å­¦ä¹ ï¼ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°†æ·±å…¥ç ”ç©¶TCPåè®®çš„æ ¸å¿ƒæœºåˆ¶ã€‚

è¿˜è®°å¾—æˆ‘ä»¬åœ¨Day 4å­¦ä¹ TCP/IPæ¨¡å‹æ—¶ï¼Œç®€å•æåˆ°äº†TCPçš„å¯é æ€§ç‰¹ç‚¹å—ï¼Ÿä»Šå¤©æˆ‘ä»¬è¦æ·±å…¥æ¢ç´¢TCPå¦‚ä½•å»ºç«‹è¿æ¥â€”â€”è‘—åçš„"ä¸‰æ¬¡æ¡æ‰‹"ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
ä¸‰æ¬¡æ¡æ‰‹å°±åƒä¸¤ä¸ªäººæ‰“ç”µè¯ï¼š
1. **ç¬¬ä¸€æ¬¡**ï¼šä½ æ‹¨é€šç”µè¯è¯´"å–‚ï¼Œèƒ½å¬åˆ°æˆ‘è¯´è¯å—ï¼Ÿ"ï¼ˆSYNï¼‰
2. **ç¬¬äºŒæ¬¡**ï¼šå¯¹æ–¹å›ç­”"å¬åˆ°äº†ï¼Œä½ èƒ½å¬åˆ°æˆ‘å—ï¼Ÿ"ï¼ˆSYN-ACKï¼‰
3. **ç¬¬ä¸‰æ¬¡**ï¼šä½ ç¡®è®¤"æˆ‘ä¹Ÿèƒ½å¬åˆ°ï¼Œå’±ä»¬å¼€å§‹èŠå§ï¼"ï¼ˆACKï¼‰

ç»è¿‡è¿™ä¸‰æ­¥ç¡®è®¤ï¼ŒåŒæ–¹éƒ½çŸ¥é“é€šä¿¡é€šé“æ˜¯ç•…é€šçš„ï¼Œå¯ä»¥å¼€å§‹æ­£å¼äº¤æµäº†ã€‚

---

## ğŸ¯ ä»Šæ—¥ç›®æ ‡

å­¦å®Œæœ¬ç« èŠ‚ï¼Œä½ å°†èƒ½å¤Ÿï¼š

- âœ… ç†è§£TCPä¸‰æ¬¡æ¡æ‰‹çš„å®Œæ•´æµç¨‹
- âœ… æŒæ¡SYNã€ACKæ ‡å¿—ä½çš„å«ä¹‰
- âœ… ç†è§£åºåˆ—å·ï¼ˆSEQï¼‰å’Œç¡®è®¤å·ï¼ˆACKï¼‰çš„ä½œç”¨
- âœ… è¯†åˆ«ä¸‰æ¬¡æ¡æ‰‹å¯èƒ½é‡åˆ°çš„é—®é¢˜
- âœ… ä½¿ç”¨å·¥å…·è§‚å¯Ÿå’Œåˆ†æä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹

---

## ğŸ“– ç†è®ºè®²è§£

### 1. ä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆä¸æ˜¯ä¸¤æ¬¡æˆ–å››æ¬¡ï¼Ÿ

**ä¸¤æ¬¡æ¡æ‰‹çš„é—®é¢˜**ï¼š
```
å®¢æˆ·ç«¯: "æˆ‘è¦è¿æ¥ä½ "          â†’ æœåŠ¡å™¨
å®¢æˆ·ç«¯:                      â† æœåŠ¡å™¨: "å¥½çš„ï¼Œè¿æ¥å»ºç«‹"
```
é—®é¢˜ï¼š
- å¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚åœ¨ç½‘ç»œä¸­å»¶è¿Ÿï¼Œåæ¥åˆåˆ°è¾¾æœåŠ¡å™¨
- æœåŠ¡å™¨ä¼šè¯¯ä»¥ä¸ºå®¢æˆ·ç«¯å‘èµ·äº†æ–°è¿æ¥
- ä½†å®¢æˆ·ç«¯å·²ç»ä¸åœ¨ç­‰å¾…äº†
- æœåŠ¡å™¨èµ„æºè¢«æµªè´¹

**å››æ¬¡æ¡æ‰‹çš„é—®é¢˜**ï¼š
- å¢åŠ å»¶è¿Ÿï¼Œæ²¡æœ‰å¿…è¦
- ä¸‰æ¬¡å·²ç»è¶³å¤Ÿç¡®è®¤åŒæ–¹çš„æ”¶å‘èƒ½åŠ›

**ä¸‰æ¬¡æ¡æ‰‹çš„ä¼˜åŠ¿**ï¼š
- âœ… ç¡®è®¤åŒæ–¹éƒ½èƒ½å‘é€å’Œæ¥æ”¶æ•°æ®
- âœ… é˜²æ­¢æ—§è¿æ¥è¯·æ±‚çš„å¹²æ‰°
- âœ… åŒæ­¥åŒæ–¹çš„åˆå§‹åºåˆ—å·
- âœ… æ•ˆç‡å’Œå¯é æ€§çš„æœ€ä½³å¹³è¡¡

---

### 2. TCPä¸‰æ¬¡æ¡æ‰‹è¯¦ç»†æµç¨‹

```
å®¢æˆ·ç«¯                                    æœåŠ¡å™¨
  |                                        |
  |  â‘   SYN=1, seq=x                      |
  |-------------------------------------> |  (æœåŠ¡å™¨è¿›å…¥SYN_RCVDçŠ¶æ€)
  |                                        |
  |  â‘¡  SYN=1, ACK=1, seq=y, ack=x+1     |
  |<------------------------------------- |
  |                                        |
  |  â‘¢  ACK=1, seq=x+1, ack=y+1          |
  |-------------------------------------> |  (è¿æ¥å»ºç«‹ï¼Œè¿›å…¥ESTABLISHEDçŠ¶æ€)
  |                                        |
  |          æ•°æ®ä¼ è¾“é˜¶æ®µ                  |
  |<=====================================>|
```

#### ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰

**å®¢æˆ·ç«¯å‘é€**ï¼š
- SYN = 1ï¼ˆåŒæ­¥æ ‡å¿—ä½ï¼Œè¡¨ç¤ºè¯·æ±‚å»ºç«‹è¿æ¥ï¼‰
- seq = xï¼ˆå®¢æˆ·ç«¯çš„åˆå§‹åºåˆ—å·ï¼Œéšæœºç”Ÿæˆï¼‰

**çŠ¶æ€å˜åŒ–**ï¼š
- å®¢æˆ·ç«¯ï¼šCLOSED â†’ SYN_SENTï¼ˆç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ï¼‰
- æœåŠ¡å™¨ï¼šLISTEN â†’ SYN_RCVDï¼ˆæ”¶åˆ°åŒæ­¥è¯·æ±‚ï¼‰

**å«ä¹‰**ï¼š
"æˆ‘æƒ³å’Œä½ å»ºç«‹è¿æ¥ï¼Œæˆ‘çš„åˆå§‹åºåˆ—å·æ˜¯x"

---

#### ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

**æœåŠ¡å™¨å‘é€**ï¼š
- SYN = 1ï¼ˆæœåŠ¡å™¨ä¹Ÿè¦è¯·æ±‚å»ºç«‹è¿æ¥ï¼‰
- ACK = 1ï¼ˆç¡®è®¤æ ‡å¿—ä½ï¼Œç¡®è®¤æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼‰
- seq = yï¼ˆæœåŠ¡å™¨çš„åˆå§‹åºåˆ—å·ï¼Œéšæœºç”Ÿæˆï¼‰
- ack = x + 1ï¼ˆç¡®è®¤å·ï¼ŒæœŸæœ›ä¸‹æ¬¡æ”¶åˆ°å®¢æˆ·ç«¯çš„åºåˆ—å·ï¼‰

**çŠ¶æ€å˜åŒ–**ï¼š
- æœåŠ¡å™¨ï¼šSYN_RCVDï¼ˆä¿æŒï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„æœ€åç¡®è®¤ï¼‰

**å«ä¹‰**ï¼š
"æˆ‘æ”¶åˆ°äº†ä½ çš„è¯·æ±‚ï¼ˆACKï¼‰ï¼Œæˆ‘ä¹Ÿæƒ³å’Œä½ å»ºç«‹è¿æ¥ï¼ˆSYNï¼‰ï¼Œæˆ‘çš„åˆå§‹åºåˆ—å·æ˜¯y"

---

#### ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰

**å®¢æˆ·ç«¯å‘é€**ï¼š
- ACK = 1ï¼ˆç¡®è®¤æ ‡å¿—ä½ï¼‰
- seq = x + 1ï¼ˆå®¢æˆ·ç«¯çš„ä¸‹ä¸€ä¸ªåºåˆ—å·ï¼‰
- ack = y + 1ï¼ˆç¡®è®¤å·ï¼ŒæœŸæœ›ä¸‹æ¬¡æ”¶åˆ°æœåŠ¡å™¨çš„åºåˆ—å·ï¼‰

**çŠ¶æ€å˜åŒ–**ï¼š
- å®¢æˆ·ç«¯ï¼šSYN_SENT â†’ ESTABLISHEDï¼ˆè¿æ¥å»ºç«‹å®Œæˆï¼‰
- æœåŠ¡å™¨ï¼šSYN_RCVD â†’ ESTABLISHEDï¼ˆè¿æ¥å»ºç«‹å®Œæˆï¼‰

**å«ä¹‰**ï¼š
"æˆ‘æ”¶åˆ°äº†ä½ çš„ç¡®è®¤ï¼Œè¿æ¥å»ºç«‹æˆåŠŸï¼Œå¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®äº†"

---

### 3. åºåˆ—å·ï¼ˆSequence Numberï¼‰å’Œç¡®è®¤å·ï¼ˆAcknowledgment Numberï¼‰

#### åºåˆ—å·ï¼ˆSEQï¼‰

**ä½œç”¨**ï¼š
- æ ‡è¯†æ¯ä¸ªå­—èŠ‚çš„æ•°æ®
- ç¡®ä¿æ•°æ®æŒ‰é¡ºåºåˆ°è¾¾
- æ£€æµ‹ä¸¢å¤±æˆ–é‡å¤çš„æ•°æ®

**ç”Ÿæˆè§„åˆ™**ï¼š
- åˆå§‹åºåˆ—å·ï¼ˆISNï¼‰æ˜¯éšæœºç”Ÿæˆçš„ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
- æ¯å‘é€1ä¸ªå­—èŠ‚ï¼Œåºåˆ—å·+1

**ç¤ºä¾‹**ï¼š
```
åˆå§‹åºåˆ—å· ISN = 1000
å‘é€100å­—èŠ‚æ•°æ®åï¼Œä¸‹ä¸€ä¸ªSEQ = 1100
å‘é€200å­—èŠ‚æ•°æ®åï¼Œä¸‹ä¸€ä¸ªSEQ = 1300
```

#### ç¡®è®¤å·ï¼ˆACKï¼‰

**ä½œç”¨**ï¼š
- å‘Šè¯‰å¯¹æ–¹"æˆ‘å·²ç»æ”¶åˆ°äº†åºåˆ—å·ä¸ºXä¹‹å‰çš„æ‰€æœ‰æ•°æ®"
- æœŸæœ›ä¸‹æ¬¡æ”¶åˆ°çš„æ•°æ®åºåˆ—å·

**è§„åˆ™**ï¼š
```
ack = å¯¹æ–¹çš„seq + æ•°æ®é•¿åº¦

ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šæ²¡æœ‰æ•°æ®ï¼Œackä¸è®¾ç½®
ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šack = x + 1ï¼ˆxæ˜¯å®¢æˆ·ç«¯çš„ISNï¼Œ+1è¡¨ç¤ºæ¡æ‰‹æŠ¥æ–‡ï¼‰
ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šack = y + 1ï¼ˆyæ˜¯æœåŠ¡å™¨çš„ISNï¼Œ+1è¡¨ç¤ºæ¡æ‰‹æŠ¥æ–‡ï¼‰
```

---

### 4. TCPæ ‡å¿—ä½è¯¦è§£

TCPæŠ¥æ–‡å¤´éƒ¨æœ‰6ä¸ªé‡è¦çš„æ ‡å¿—ä½ï¼ˆFlagsï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ â”‚ åç§°â”‚ è¯´æ˜                             â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ URGâ”‚ ç´§æ€¥â”‚ ç´§æ€¥æŒ‡é’ˆæœ‰æ•ˆ                     â”‚
â”‚ ACKâ”‚ ç¡®è®¤â”‚ ç¡®è®¤å·æœ‰æ•ˆï¼ˆç¬¬äºŒæ¬¡æ¡æ‰‹åå§‹ç»ˆä¸º1ï¼‰â”‚
â”‚ PSHâ”‚ æ¨é€â”‚ ç«‹å³æ¨é€æ•°æ®ç»™åº”ç”¨å±‚             â”‚
â”‚ RSTâ”‚ å¤ä½â”‚ é‡ç½®è¿æ¥ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰             â”‚
â”‚ SYNâ”‚ åŒæ­¥â”‚ è¯·æ±‚å»ºç«‹è¿æ¥ï¼ˆæ¡æ‰‹æ—¶ä½¿ç”¨ï¼‰       â”‚
â”‚ FINâ”‚ ç»“æŸâ”‚ è¯·æ±‚å…³é—­è¿æ¥ï¼ˆæŒ¥æ‰‹æ—¶ä½¿ç”¨ï¼‰       â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‰æ¬¡æ¡æ‰‹ä½¿ç”¨çš„æ ‡å¿—ä½**ï¼š
- ç¬¬ä¸€æ¬¡ï¼šSYN = 1
- ç¬¬äºŒæ¬¡ï¼šSYN = 1, ACK = 1
- ç¬¬ä¸‰æ¬¡ï¼šACK = 1

---

### 5. TCPè¿æ¥çŠ¶æ€è½¬æ¢

```
å®¢æˆ·ç«¯çŠ¶æ€è½¬æ¢ï¼š
CLOSED â†’ SYN_SENT â†’ ESTABLISHED

æœåŠ¡å™¨çŠ¶æ€è½¬æ¢ï¼š
CLOSED â†’ LISTEN â†’ SYN_RCVD â†’ ESTABLISHED
```

**å®Œæ•´çš„TCPçŠ¶æ€æœº**ï¼ˆä»Šå¤©é‡ç‚¹å…³æ³¨æ¡æ‰‹éƒ¨åˆ†ï¼‰ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CLOSED  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        ä¸»åŠ¨æ‰“å¼€          â”‚          è¢«åŠ¨æ‰“å¼€
     ï¼ˆå®¢æˆ·ç«¯ï¼‰           â”‚         ï¼ˆæœåŠ¡å™¨ï¼‰
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚SYN_SENT â”‚                    â”‚ LISTEN  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                               â”‚
         â”‚æ”¶åˆ°SYN-ACK                    â”‚æ”¶åˆ°SYN
         â”‚å‘é€ACK                        â”‚å‘é€SYN-ACK
         â”‚                               â”‚
         â”‚                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
         â”‚                          â”‚SYN_RCVD â”‚
         â”‚                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                               â”‚
         â”‚                               â”‚æ”¶åˆ°ACK
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
               â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
               â”‚ESTABLISHEDâ”‚  â† è¿æ¥å»ºç«‹æˆåŠŸ
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6. å¸¸è§é—®é¢˜å’Œå¼‚å¸¸æƒ…å†µ

#### é—®é¢˜1ï¼šSYNæ´ªæ°´æ”»å‡»ï¼ˆSYN Floodï¼‰

**æ”»å‡»åŸç†**ï¼š
```
æ”»å‡»è€…å‘é€å¤§é‡SYNè¯·æ±‚ â†’ æœåŠ¡å™¨è¿›å…¥SYN_RCVDçŠ¶æ€
æ”»å‡»è€…ä¸å›åº”ç¬¬ä¸‰æ¬¡æ¡æ‰‹ â†’ æœåŠ¡å™¨èµ„æºè¢«è€—å°½
```

**é˜²å¾¡æ–¹æ³•**ï¼š
- SYN CookieæŠ€æœ¯
- å¢åŠ åŠè¿æ¥é˜Ÿåˆ—å¤§å°
- ç¼©çŸ­SYN_RCVDè¶…æ—¶æ—¶é—´
- ä½¿ç”¨é˜²ç«å¢™è¿‡æ»¤

#### é—®é¢˜2ï¼šæ¡æ‰‹è¶…æ—¶

**åœºæ™¯**ï¼š
- ç½‘ç»œå»¶è¿Ÿè¿‡å¤§
- é˜²ç«å¢™é˜»æ­¢è¿æ¥
- æœåŠ¡å™¨æœªç›‘å¬ç«¯å£

**è¡¨ç°**ï¼š
```bash
# ä½¿ç”¨telnetæµ‹è¯•
telnet example.com 80
# é•¿æ—¶é—´ç­‰å¾…åæ˜¾ç¤ºï¼š
Connection timed out
```

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
- ç¡®è®¤ç«¯å£å¼€æ”¾
- è°ƒæ•´è¶…æ—¶å‚æ•°

#### é—®é¢˜3ï¼šRSTè¿æ¥é‡ç½®

**åœºæ™¯**ï¼š
- ç«¯å£æœªå¼€æ”¾
- è¿æ¥è¢«æ‹’ç»
- é˜²ç«å¢™ç­–ç•¥

**è¡¨ç°**ï¼š
```
å®¢æˆ·ç«¯: SYN                â†’ æœåŠ¡å™¨
å®¢æˆ·ç«¯:                    â† æœåŠ¡å™¨: RST, ACK
```

---

## ğŸ’» å®æˆ˜é¡¹ç›®ï¼šTCPä¸‰æ¬¡æ¡æ‰‹æ¼”ç¤ºå·¥å…·

ä»Šå¤©æˆ‘ä»¬å®ç°ä¸€ä¸ªå·¥å…·ï¼Œæ¨¡æ‹Ÿå’Œè§‚å¯ŸTCPä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚

### é¡¹ç›®åŠŸèƒ½

1. **æ¨¡æ‹Ÿæ¡æ‰‹è¿‡ç¨‹**ï¼šæ¼”ç¤ºä¸‰æ¬¡æ¡æ‰‹çš„å®Œæ•´æµç¨‹
2. **æ•è·çœŸå®æ¡æ‰‹**ï¼šæŠ“å–å®é™…çš„TCPæ¡æ‰‹åŒ…
3. **çŠ¶æ€è·Ÿè¸ª**ï¼šæ˜¾ç¤ºè¿æ¥çŠ¶æ€çš„å˜åŒ–
4. **æ—¶åºåˆ†æ**ï¼šè®¡ç®—æ¡æ‰‹è€—æ—¶

### ä»£ç å®ç°

```python
# day41_tcp_handshake_demo.py
# åŠŸèƒ½ï¼šTCPä¸‰æ¬¡æ¡æ‰‹æ¼”ç¤ºå’Œåˆ†æå·¥å…·

import socket
import struct
import time
from dataclasses import dataclass
from typing import Optional

@dataclass
class TCPPacket:
    """TCPæ•°æ®åŒ…ç»“æ„"""
    src_port: int           # æºç«¯å£
    dst_port: int           # ç›®æ ‡ç«¯å£
    seq: int                # åºåˆ—å·
    ack: int                # ç¡®è®¤å·
    flags: int              # æ ‡å¿—ä½
    window: int             # çª—å£å¤§å°

    def __str__(self):
        """æ ¼å¼åŒ–æ˜¾ç¤ºTCPåŒ…ä¿¡æ¯"""
        flag_str = []
        if self.flags & 0x01: flag_str.append('FIN')
        if self.flags & 0x02: flag_str.append('SYN')
        if self.flags & 0x04: flag_str.append('RST')
        if self.flags & 0x08: flag_str.append('PSH')
        if self.flags & 0x10: flag_str.append('ACK')
        if self.flags & 0x20: flag_str.append('URG')

        return (f"[{self.src_port}â†’{self.dst_port}] "
                f"SEQ={self.seq} ACK={self.ack} "
                f"Flags=[{','.join(flag_str)}]")


class HandshakeSimulator:
    """ä¸‰æ¬¡æ¡æ‰‹æ¨¡æ‹Ÿå™¨"""

    def __init__(self):
        self.client_state = "CLOSED"
        self.server_state = "CLOSED"
        self.client_seq = self._random_seq()
        self.server_seq = self._random_seq()
        self.steps = []

    def _random_seq(self) -> int:
        """
        ç”Ÿæˆéšæœºåˆå§‹åºåˆ—å·

        è¿”å›å€¼ï¼š
            éšæœºçš„32ä½åºåˆ—å·

        å·¥ä½œåŸç†ï¼š
            ä½¿ç”¨å½“å‰æ—¶é—´æˆ³ç”Ÿæˆéšæœºæ•°ï¼Œæ¨¡æ‹ŸçœŸå®çš„ISNç”Ÿæˆ
        """
        import random
        return random.randint(0, 2**32 - 1)

    def simulate_handshake(self, verbose: bool = True):
        """
        æ¨¡æ‹Ÿå®Œæ•´çš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹

        å‚æ•°è¯´æ˜ï¼š
            verbose: æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

        å·¥ä½œåŸç†ï¼š
            æŒ‰ç…§TCPåè®®è§„èŒƒï¼Œæ¨¡æ‹Ÿå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„æ¡æ‰‹äº¤äº’
        """
        if verbose:
            print("=" * 70)
            print("TCPä¸‰æ¬¡æ¡æ‰‹æ¨¡æ‹Ÿ")
            print("=" * 70)
            print()

        # ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€SYN
        self._first_handshake(verbose)
        time.sleep(0.1)

        # ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡å™¨å‘é€SYN-ACK
        self._second_handshake(verbose)
        time.sleep(0.1)

        # ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ACK
        self._third_handshake(verbose)

        if verbose:
            print("\n" + "=" * 70)
            print("âœ… è¿æ¥å»ºç«‹æˆåŠŸï¼åŒæ–¹è¿›å…¥ESTABLISHEDçŠ¶æ€")
            print("=" * 70)
            print(f"\nå®¢æˆ·ç«¯ISN: {self.client_seq}")
            print(f"æœåŠ¡å™¨ISN: {self.server_seq}")

    def _first_handshake(self, verbose: bool):
        """
        ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ (SYN)
        """
        self.client_state = "SYN_SENT"
        self.server_state = "LISTEN"

        packet = TCPPacket(
            src_port=54321,
            dst_port=80,
            seq=self.client_seq,
            ack=0,
            flags=0x02,  # SYN
            window=65535
        )

        self.steps.append(('clientâ†’server', packet))

        if verbose:
            print("ã€ç¬¬ä¸€æ¬¡æ¡æ‰‹ã€‘å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨")
            print(f"  å®¢æˆ·ç«¯çŠ¶æ€: CLOSED â†’ {self.client_state}")
            print(f"  å‘é€: SYN=1, seq={self.client_seq}")
            print(f"  æ•°æ®åŒ…: {packet}")
            print(f"  å«ä¹‰: å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼Œåˆå§‹åºåˆ—å·ä¸º{self.client_seq}")
            print()

    def _second_handshake(self, verbose: bool):
        """
        ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (SYN-ACK)
        """
        self.server_state = "SYN_RCVD"

        packet = TCPPacket(
            src_port=80,
            dst_port=54321,
            seq=self.server_seq,
            ack=self.client_seq + 1,
            flags=0x12,  # SYN + ACK
            window=65535
        )

        self.steps.append(('serverâ†’client', packet))

        if verbose:
            print("ã€ç¬¬äºŒæ¬¡æ¡æ‰‹ã€‘æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯")
            print(f"  æœåŠ¡å™¨çŠ¶æ€: LISTEN â†’ {self.server_state}")
            print(f"  å‘é€: SYN=1, ACK=1, seq={self.server_seq}, ack={self.client_seq + 1}")
            print(f"  æ•°æ®åŒ…: {packet}")
            print(f"  å«ä¹‰: æœåŠ¡å™¨ç¡®è®¤å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å‘é€è‡ªå·±çš„åˆå§‹åºåˆ—å·{self.server_seq}")
            print()

    def _third_handshake(self, verbose: bool):
        """
        ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ (ACK)
        """
        self.client_state = "ESTABLISHED"
        self.server_state = "ESTABLISHED"

        packet = TCPPacket(
            src_port=54321,
            dst_port=80,
            seq=self.client_seq + 1,
            ack=self.server_seq + 1,
            flags=0x10,  # ACK
            window=65535
        )

        self.steps.append(('clientâ†’server', packet))

        if verbose:
            print("ã€ç¬¬ä¸‰æ¬¡æ¡æ‰‹ã€‘å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨")
            print(f"  å®¢æˆ·ç«¯çŠ¶æ€: SYN_SENT â†’ {self.client_state}")
            print(f"  æœåŠ¡å™¨çŠ¶æ€: SYN_RCVD â†’ {self.server_state}")
            print(f"  å‘é€: ACK=1, seq={self.client_seq + 1}, ack={self.server_seq + 1}")
            print(f"  æ•°æ®åŒ…: {packet}")
            print(f"  å«ä¹‰: å®¢æˆ·ç«¯ç¡®è®¤æœåŠ¡å™¨çš„å“åº”ï¼Œè¿æ¥å»ºç«‹å®Œæˆ")
            print()


class HandshakeAnalyzer:
    """çœŸå®TCPæ¡æ‰‹åˆ†æå™¨"""

    def __init__(self, target_host: str, target_port: int = 80):
        self.target_host = target_host
        self.target_port = target_port

    def perform_handshake(self, verbose: bool = True):
        """
        æ‰§è¡ŒçœŸå®çš„TCPè¿æ¥ï¼Œå¹¶åˆ†ææ¡æ‰‹è¿‡ç¨‹

        å‚æ•°è¯´æ˜ï¼š
            verbose: æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

        å·¥ä½œåŸç†ï¼š
            åˆ›å»ºTCP socketè¿æ¥ï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨å®Œæˆä¸‰æ¬¡æ¡æ‰‹
            æˆ‘ä»¬é€šè¿‡æµ‹é‡æ—¶é—´æ¥åˆ†ææ¡æ‰‹æ€§èƒ½
        """
        if verbose:
            print("=" * 70)
            print(f"çœŸå®TCPæ¡æ‰‹åˆ†æï¼š{self.target_host}:{self.target_port}")
            print("=" * 70)
            print()

        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)

        try:
            if verbose:
                print(f"ğŸ”— æ­£åœ¨è¿æ¥ {self.target_host}:{self.target_port}...")

            start_time = time.time()
            sock.connect((self.target_host, self.target_port))
            handshake_time = (time.time() - start_time) * 1000

            if verbose:
                print(f"âœ… è¿æ¥æˆåŠŸï¼")
                print(f"â±ï¸  æ¡æ‰‹è€—æ—¶: {handshake_time:.2f} ms")
                print()

                # è·å–æœ¬åœ°å’Œè¿œç¨‹åœ°å€
                local_addr = sock.getsockname()
                remote_addr = sock.getpeername()

                print("è¿æ¥ä¿¡æ¯ï¼š")
                print(f"  æœ¬åœ°åœ°å€: {local_addr[0]}:{local_addr[1]}")
                print(f"  è¿œç¨‹åœ°å€: {remote_addr[0]}:{remote_addr[1]}")
                print(f"  è¿æ¥çŠ¶æ€: ESTABLISHED")
                print()

                # ä¼°ç®—RTTï¼ˆå¾€è¿”æ—¶é—´ï¼‰
                rtt = handshake_time / 1.5  # ä¸‰æ¬¡æ¡æ‰‹çº¦1.5ä¸ªRTT
                print(f"ğŸ“Š æ€§èƒ½åˆ†æï¼š")
                print(f"  ä¼°ç®—RTT: {rtt:.2f} ms")
                print(f"  ç½‘ç»œå»¶è¿Ÿ: {'ä¼˜ç§€' if rtt < 50 else 'è‰¯å¥½' if rtt < 100 else 'ä¸€èˆ¬'}")

            return True, handshake_time

        except socket.timeout:
            if verbose:
                print("âŒ è¿æ¥è¶…æ—¶ï¼å¯èƒ½çš„åŸå› ï¼š")
                print("  1. ç›®æ ‡ä¸»æœºä¸å¯è¾¾")
                print("  2. é˜²ç«å¢™é˜»æ­¢è¿æ¥")
                print("  3. ç½‘ç»œå»¶è¿Ÿè¿‡å¤§")
            return False, None

        except ConnectionRefusedError:
            if verbose:
                print("âŒ è¿æ¥è¢«æ‹’ç»ï¼å¯èƒ½çš„åŸå› ï¼š")
                print("  1. ç›®æ ‡ç«¯å£æœªå¼€æ”¾")
                print("  2. æœåŠ¡æœªè¿è¡Œ")
                print("  3. é˜²ç«å¢™ç­–ç•¥")
            return False, None

        except Exception as e:
            if verbose:
                print(f"âŒ è¿æ¥å¤±è´¥: {e}")
            return False, None

        finally:
            sock.close()


class HandshakeVisualizer:
    """æ¡æ‰‹è¿‡ç¨‹å¯è§†åŒ–å·¥å…·"""

    @staticmethod
    def draw_handshake():
        """
        ç»˜åˆ¶ä¸‰æ¬¡æ¡æ‰‹çš„ASCIIæµç¨‹å›¾
        """
        print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯        â”‚                           â”‚   æœåŠ¡å™¨        â”‚
â”‚   (Client)      â”‚                           â”‚   (Server)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                              â”‚
         â”‚  çŠ¶æ€: CLOSED                                â”‚  çŠ¶æ€: LISTEN
         â”‚                                              â”‚
         â”‚                                              â”‚
         â”‚  â‘  SYN=1, seq=x                             â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚  çŠ¶æ€: SYN_SENT                              â”‚  çŠ¶æ€: SYN_RCVD
         â”‚                                              â”‚
         â”‚                                              â”‚
         â”‚  â‘¡ SYN=1, ACK=1, seq=y, ack=x+1            â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                                              â”‚
         â”‚                                              â”‚
         â”‚  â‘¢ ACK=1, seq=x+1, ack=y+1                 â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚  çŠ¶æ€: ESTABLISHED                           â”‚  çŠ¶æ€: ESTABLISHED
         â”‚                                              â”‚
         â”‚                                              â”‚
         â”‚           å¯ä»¥å¼€å§‹æ•°æ®ä¼ è¾“äº†                 â”‚
         â”‚<============================================>â”‚
         â”‚                                              â”‚
        """)

    @staticmethod
    def explain_flags():
        """
        è§£é‡ŠTCPæ ‡å¿—ä½
        """
        print("""
TCPæ ‡å¿—ä½è¯´æ˜ï¼š

â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½  â”‚ åç§°     â”‚ ä½œç”¨                           â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SYN â”‚ åŒæ­¥     â”‚ å»ºç«‹è¿æ¥ï¼ˆæ¡æ‰‹ï¼‰               â”‚
â”‚ ACK â”‚ ç¡®è®¤     â”‚ ç¡®è®¤æ”¶åˆ°æ•°æ®                   â”‚
â”‚ FIN â”‚ ç»“æŸ     â”‚ å…³é—­è¿æ¥ï¼ˆæŒ¥æ‰‹ï¼‰               â”‚
â”‚ RST â”‚ å¤ä½     â”‚ é‡ç½®è¿æ¥ï¼ˆå¼‚å¸¸ï¼‰               â”‚
â”‚ PSH â”‚ æ¨é€     â”‚ ç«‹å³æ¨é€ç»™åº”ç”¨å±‚               â”‚
â”‚ URG â”‚ ç´§æ€¥     â”‚ ç´§æ€¥æ•°æ®                       â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸‰æ¬¡æ¡æ‰‹ä½¿ç”¨çš„æ ‡å¿—ä½ï¼š
  ç¬¬ä¸€æ¬¡æ¡æ‰‹: SYN=1
  ç¬¬äºŒæ¬¡æ¡æ‰‹: SYN=1, ACK=1
  ç¬¬ä¸‰æ¬¡æ¡æ‰‹: ACK=1
        """)


def main():
    """
    ä¸»å‡½æ•°ï¼šæ¼”ç¤ºTCPä¸‰æ¬¡æ¡æ‰‹
    """
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          TCPä¸‰æ¬¡æ¡æ‰‹æ·±å…¥åˆ†æ - Day 41 å®æˆ˜é¡¹ç›®              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

    # 1. æ˜¾ç¤ºæ¡æ‰‹æµç¨‹å›¾
    print("\nã€1. ä¸‰æ¬¡æ¡æ‰‹æµç¨‹å›¾ã€‘")
    HandshakeVisualizer.draw_handshake()

    # 2. æ¨¡æ‹Ÿæ¡æ‰‹è¿‡ç¨‹
    print("\nã€2. æ¡æ‰‹è¿‡ç¨‹æ¨¡æ‹Ÿã€‘")
    simulator = HandshakeSimulator()
    simulator.simulate_handshake()

    # 3. æ˜¾ç¤ºæ ‡å¿—ä½è¯´æ˜
    print("\nã€3. TCPæ ‡å¿—ä½è¯´æ˜ã€‘")
    HandshakeVisualizer.explain_flags()

    # 4. çœŸå®æ¡æ‰‹åˆ†æ
    print("\nã€4. çœŸå®TCPæ¡æ‰‹åˆ†æã€‘")

    # æµ‹è¯•å¤šä¸ªç›®æ ‡
    targets = [
        ('www.baidu.com', 80),
        ('www.google.com', 443),
    ]

    for host, port in targets:
        analyzer = HandshakeAnalyzer(host, port)
        analyzer.perform_handshake()
        print()

    # 5. æ€§èƒ½å¯¹æ¯”
    print("ã€5. æ¡æ‰‹æ€§èƒ½å¯¹æ¯”ã€‘")
    print("æµ‹è¯•ä¸åŒä¸»æœºçš„æ¡æ‰‹æ€§èƒ½...\n")

    results = []
    test_hosts = [
        ('ç™¾åº¦', 'www.baidu.com', 80),
        ('æ·˜å®', 'www.taobao.com', 443),
    ]

    for name, host, port in test_hosts:
        analyzer = HandshakeAnalyzer(host, port)
        success, time_ms = analyzer.perform_handshake(verbose=False)
        if success:
            results.append((name, time_ms))
            print(f"  {name:8s}: {time_ms:6.2f} ms")

    if results:
        print(f"\næœ€å¿«: {min(results, key=lambda x: x[1])[0]}")
        print(f"æœ€æ…¢: {max(results, key=lambda x: x[1])[0]}")


if __name__ == "__main__":
    main()
```

---

## ğŸ” ä»£ç è¯¦è§£

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. TCPæ•°æ®åŒ…ç»“æ„

```python
@dataclass
class TCPPacket:
    src_port: int      # æºç«¯å£
    dst_port: int      # ç›®æ ‡ç«¯å£
    seq: int           # åºåˆ—å·ï¼ˆ32ä½ï¼‰
    ack: int           # ç¡®è®¤å·ï¼ˆ32ä½ï¼‰
    flags: int         # æ ‡å¿—ä½ï¼ˆ6ä½ï¼‰
    window: int        # çª—å£å¤§å°
```

**æ ‡å¿—ä½ç¼–ç **ï¼š
```
0x02 = 0000 0010 = SYN
0x10 = 0001 0000 = ACK
0x12 = 0001 0010 = SYN + ACK
```

#### 2. åºåˆ—å·ç”Ÿæˆ

```python
def _random_seq(self) -> int:
    import random
    return random.randint(0, 2**32 - 1)
```

**ä¸ºä»€ä¹ˆéšæœº**ï¼š
- å®‰å…¨æ€§ï¼šé˜²æ­¢åºåˆ—å·è¢«çŒœæµ‹
- é¿å…æ—§è¿æ¥æ•°æ®å¹²æ‰°

#### 3. Socketè¿æ¥

```python
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((host, port))
```

**èƒŒåçš„ä¸‰æ¬¡æ¡æ‰‹**ï¼š
- `connect()`å‡½æ•°è‡ªåŠ¨è§¦å‘ä¸‰æ¬¡æ¡æ‰‹
- æ“ä½œç³»ç»Ÿå†…æ ¸å®Œæˆå…·ä½“è¿‡ç¨‹
- æˆåŠŸè¿”å›åï¼Œè¿æ¥å·²å»ºç«‹

---

## ğŸ“ è¿è¡Œç¤ºä¾‹

### è¿è¡Œæ–¹æ³•

```bash
python code/day41/day41_tcp_handshake_demo.py
```

### é¢„æœŸè¾“å‡º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          TCPä¸‰æ¬¡æ¡æ‰‹æ·±å…¥åˆ†æ - Day 41 å®æˆ˜é¡¹ç›®              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€1. ä¸‰æ¬¡æ¡æ‰‹æµç¨‹å›¾ã€‘
[æ˜¾ç¤ºASCIIæµç¨‹å›¾]

ã€2. æ¡æ‰‹è¿‡ç¨‹æ¨¡æ‹Ÿã€‘
======================================================================
TCPä¸‰æ¬¡æ¡æ‰‹æ¨¡æ‹Ÿ
======================================================================

ã€ç¬¬ä¸€æ¬¡æ¡æ‰‹ã€‘å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
  å®¢æˆ·ç«¯çŠ¶æ€: CLOSED â†’ SYN_SENT
  å‘é€: SYN=1, seq=1234567890
  æ•°æ®åŒ…: [54321â†’80] SEQ=1234567890 ACK=0 Flags=[SYN]
  å«ä¹‰: å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ï¼Œåˆå§‹åºåˆ—å·ä¸º1234567890

ã€ç¬¬äºŒæ¬¡æ¡æ‰‹ã€‘æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
  æœåŠ¡å™¨çŠ¶æ€: LISTEN â†’ SYN_RCVD
  å‘é€: SYN=1, ACK=1, seq=9876543210, ack=1234567891
  æ•°æ®åŒ…: [80â†’54321] SEQ=9876543210 ACK=1234567891 Flags=[SYN,ACK]
  å«ä¹‰: æœåŠ¡å™¨ç¡®è®¤å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å‘é€è‡ªå·±çš„åˆå§‹åºåˆ—å·9876543210

ã€ç¬¬ä¸‰æ¬¡æ¡æ‰‹ã€‘å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
  å®¢æˆ·ç«¯çŠ¶æ€: SYN_SENT â†’ ESTABLISHED
  æœåŠ¡å™¨çŠ¶æ€: SYN_RCVD â†’ ESTABLISHED
  å‘é€: ACK=1, seq=1234567891, ack=9876543211
  æ•°æ®åŒ…: [54321â†’80] SEQ=1234567891 ACK=9876543211 Flags=[ACK]
  å«ä¹‰: å®¢æˆ·ç«¯ç¡®è®¤æœåŠ¡å™¨çš„å“åº”ï¼Œè¿æ¥å»ºç«‹å®Œæˆ

======================================================================
âœ… è¿æ¥å»ºç«‹æˆåŠŸï¼åŒæ–¹è¿›å…¥ESTABLISHEDçŠ¶æ€
======================================================================

å®¢æˆ·ç«¯ISN: 1234567890
æœåŠ¡å™¨ISN: 9876543210

ã€4. çœŸå®TCPæ¡æ‰‹åˆ†æã€‘
======================================================================
çœŸå®TCPæ¡æ‰‹åˆ†æï¼šwww.baidu.com:80
======================================================================

ğŸ”— æ­£åœ¨è¿æ¥ www.baidu.com:80...
âœ… è¿æ¥æˆåŠŸï¼
â±ï¸  æ¡æ‰‹è€—æ—¶: 25.34 ms

è¿æ¥ä¿¡æ¯ï¼š
  æœ¬åœ°åœ°å€: 192.168.1.100:54321
  è¿œç¨‹åœ°å€: 39.156.66.10:80
  è¿æ¥çŠ¶æ€: ESTABLISHED

ğŸ“Š æ€§èƒ½åˆ†æï¼š
  ä¼°ç®—RTT: 16.89 ms
  ç½‘ç»œå»¶è¿Ÿ: ä¼˜ç§€
```

---

## ğŸ’¡ çŸ¥è¯†å°ç»“

ä»Šå¤©æˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†TCPä¸‰æ¬¡æ¡æ‰‹ï¼ŒæŒæ¡äº†ä»¥ä¸‹æ ¸å¿ƒçŸ¥è¯†ï¼š

### å…³é”®è¦ç‚¹

1. **ä¸‰æ¬¡æ¡æ‰‹çš„å¿…è¦æ€§**ï¼š
   - ç¡®è®¤åŒæ–¹æ”¶å‘èƒ½åŠ›
   - åŒæ­¥åˆå§‹åºåˆ—å·
   - é˜²æ­¢æ—§è¿æ¥å¹²æ‰°

2. **æ¡æ‰‹æµç¨‹**ï¼š
   ```
   â‘  å®¢æˆ·ç«¯å‘é€SYNï¼Œseq=x
   â‘¡ æœåŠ¡å™¨å‘é€SYN-ACKï¼Œseq=y, ack=x+1
   â‘¢ å®¢æˆ·ç«¯å‘é€ACKï¼Œseq=x+1, ack=y+1
   ```

3. **çŠ¶æ€è½¬æ¢**ï¼š
   ```
   å®¢æˆ·ç«¯ï¼šCLOSED â†’ SYN_SENT â†’ ESTABLISHED
   æœåŠ¡å™¨ï¼šLISTEN â†’ SYN_RCVD â†’ ESTABLISHED
   ```

4. **åºåˆ—å·ä½œç”¨**ï¼š
   - æ ‡è¯†æ•°æ®å­—èŠ‚
   - ä¿è¯é¡ºåº
   - æ£€æµ‹ä¸¢å¤±

5. **å¸¸è§é—®é¢˜**ï¼š
   - SYNæ´ªæ°´æ”»å‡»
   - è¿æ¥è¶…æ—¶
   - è¿æ¥è¢«æ‹’ç»

### è®°å¿†å£è¯€

```
ä¸‰æ¬¡æ¡æ‰‹è®°å¿ƒé—´ï¼š
ä¸€é—®ï¼šå®¢æˆ·ç«¯é—®"èƒ½è¿å—ï¼Ÿ"ï¼ˆSYNï¼‰
äºŒç­”ï¼šæœåŠ¡å™¨ç­”"å¯ä»¥ï¼ä½ èƒ½è¿æˆ‘å—ï¼Ÿ"ï¼ˆSYN-ACKï¼‰
ä¸‰è®¤ï¼šå®¢æˆ·ç«¯è®¤"æ²¡é—®é¢˜ï¼Œå¼€å§‹èŠï¼"ï¼ˆACKï¼‰
```

---

## ğŸ‹ï¸ ç»ƒä¹ é¢˜

### åŸºç¡€é¢˜

1. **ä¸ºä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹è€Œä¸æ˜¯ä¸¤æ¬¡ï¼Ÿ**
   - æç¤ºï¼šè€ƒè™‘æ—§è¿æ¥è¯·æ±‚çš„é—®é¢˜

2. **è§£é‡Šç¬¬äºŒæ¬¡æ¡æ‰‹ä¸ºä»€ä¹ˆè¦å‘é€SYNï¼Ÿ**
   - æç¤ºï¼šæœåŠ¡å™¨ä¹Ÿéœ€è¦å»ºç«‹è¿æ¥

3. **å¦‚æœç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ACKä¸¢å¤±äº†ä¼šæ€æ ·ï¼Ÿ**
   - æç¤ºï¼šè€ƒè™‘æœåŠ¡å™¨çš„é‡ä¼ æœºåˆ¶

### è¿›é˜¶é¢˜

4. **ç¼–ç¨‹é¢˜ï¼šç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­ç»™å®šçš„TCPæ ‡å¿—ä½æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ¡æ‰‹åŒ…**

```python
def is_valid_handshake_packet(flags, handshake_step):
    """
    åˆ¤æ–­TCPæ ‡å¿—ä½æ˜¯å¦ç¬¦åˆæ¡æ‰‹è¦æ±‚

    å‚æ•°ï¼š
        flags: TCPæ ‡å¿—ä½ï¼ˆæ•´æ•°ï¼‰
        handshake_step: æ¡æ‰‹æ­¥éª¤ï¼ˆ1, 2, 3ï¼‰

    è¿”å›ï¼š
        True/False
    """
    # ä½ çš„ä»£ç 
    pass

# æµ‹è¯•
print(is_valid_handshake_packet(0x02, 1))  # True (SYN)
print(is_valid_handshake_packet(0x12, 2))  # True (SYN-ACK)
print(is_valid_handshake_packet(0x10, 3))  # True (ACK)
print(is_valid_handshake_packet(0x02, 3))  # False (é”™è¯¯)
```

5. **æ€è€ƒé¢˜ï¼šä¸ºä»€ä¹ˆåˆå§‹åºåˆ—å·è¦éšæœºç”Ÿæˆï¼Ÿ**

---

## ğŸ“š æ‰©å±•é˜…è¯»

### TCP Fast Open (TFO)

**ä¼ ç»Ÿä¸‰æ¬¡æ¡æ‰‹çš„é—®é¢˜**ï¼š
- éœ€è¦1.5ä¸ªRTTæ‰èƒ½å¼€å§‹ä¼ è¾“æ•°æ®
- å¯¹äºçŸ­è¿æ¥å¾ˆæµªè´¹æ—¶é—´

**TFOè§£å†³æ–¹æ¡ˆ**ï¼š
```
ä¼ ç»Ÿæ¡æ‰‹ï¼š1.5 RTTå¼€å§‹ä¼ è¾“æ•°æ®
TFOï¼š    0 RTTå¼€å§‹ä¼ è¾“æ•°æ®ï¼ˆä½¿ç”¨Cookieï¼‰

ç¬¬ä¸€æ¬¡è¿æ¥ï¼š
å®¢æˆ·ç«¯ â†’ SYN + Cookieè¯·æ±‚ â†’ æœåŠ¡å™¨
å®¢æˆ·ç«¯ â† SYN-ACK + Cookie â† æœåŠ¡å™¨

åç»­è¿æ¥ï¼š
å®¢æˆ·ç«¯ â†’ SYN + Cookie + æ•°æ® â†’ æœåŠ¡å™¨ï¼ˆç›´æ¥å‘é€æ•°æ®ï¼ï¼‰
å®¢æˆ·ç«¯ â† SYN-ACK + æ•°æ®      â† æœåŠ¡å™¨
```

### Linuxä¸­æŸ¥çœ‹TCPè¿æ¥çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰TCPè¿æ¥
netstat -ant

# æŸ¥çœ‹ESTABLISHEDè¿æ¥
netstat -ant | grep ESTABLISHED

# æŸ¥çœ‹å„çŠ¶æ€çš„è¿æ¥æ•°
netstat -ant | awk '{print $6}' | sort | uniq -c

# ä½¿ç”¨sså‘½ä»¤ï¼ˆæ›´å¿«ï¼‰
ss -ant

# æŸ¥çœ‹ç‰¹å®šç«¯å£çš„è¿æ¥
ss -ant | grep :80
```

### æŠ“åŒ…æŸ¥çœ‹ä¸‰æ¬¡æ¡æ‰‹

ä½¿ç”¨Wiresharkæˆ–tcpdumpï¼š

```bash
# æŠ“å–æŒ‡å®šä¸»æœºçš„TCPåŒ…
sudo tcpdump -i any host www.baidu.com and tcp -w handshake.pcap

# ç„¶åç”¨Wiresharkæ‰“å¼€handshake.pcap
# è¿‡æ»¤å™¨ï¼štcp.flags.syn==1 or tcp.flags.ack==1
```

---

## ğŸ”œ æ˜å¤©é¢„å‘Š

**Day 42: TCPå››æ¬¡æŒ¥æ‰‹å’ŒçŠ¶æ€æœº**

æ˜å¤©æˆ‘ä»¬å°†å­¦ä¹ ï¼š
- TCPå¦‚ä½•ä¼˜é›…åœ°å…³é—­è¿æ¥ï¼ˆå››æ¬¡æŒ¥æ‰‹ï¼‰
- å®Œæ•´çš„TCPçŠ¶æ€æœº
- TIME_WAITçŠ¶æ€çš„ä½œç”¨
- å„ç§å¼‚å¸¸å…³é—­æƒ…å†µ
- å®æˆ˜ï¼šTCPè¿æ¥ç”Ÿå‘½å‘¨æœŸç›‘æ§å·¥å…·

è¿æ¥çš„å»ºç«‹æˆ‘ä»¬å·²ç»æŒæ¡äº†ï¼Œæ˜å¤©å­¦ä¹ å¦‚ä½•ä¼˜é›…åœ°è¯´"å†è§"ï¼

---

**è¿›åº¦ï¼š41/120å¤©ï¼ˆ34.2%ï¼‰**

æ­å–œä½ å®Œæˆäº†Day 41çš„å­¦ä¹ ï¼TCPä¸‰æ¬¡æ¡æ‰‹æ˜¯ç½‘ç»œç¼–ç¨‹çš„åŸºçŸ³ï¼ŒåŠ¡å¿…ç‰¢å›ºæŒæ¡ï¼

æ˜å¤©æˆ‘ä»¬ç»§ç»­æ¢ç´¢TCPçš„ç²¾å½©ä¸–ç•Œï¼ğŸ’ª
