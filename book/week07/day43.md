# Day 43: TCPæµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£ï¼‰

## ğŸ“š ä»Šæ—¥å¯¼è¯­

åœ¨å‰ä¸¤å¤©æˆ‘ä»¬å­¦ä¹ äº†TCPå¦‚ä½•å»ºç«‹å’Œå…³é—­è¿æ¥ï¼Œä»Šå¤©æˆ‘ä»¬è¦å­¦ä¹ TCPå¦‚ä½•æ§åˆ¶æ•°æ®ä¼ è¾“çš„é€Ÿåº¦â€”â€”æµé‡æ§åˆ¶ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
æƒ³è±¡ä½ åœ¨ç»™æœ‹å‹å€’æ°´ï¼š
- ğŸš° **æ²¡æœ‰æµé‡æ§åˆ¶**ï¼šä¸ç®¡æ¯å­å¤šå¤§ï¼Œä¸€ç›´çŒ›å€’ â†’ æ°´æº¢å‡º âŒ
- âœ… **æœ‰æµé‡æ§åˆ¶**ï¼šçœ‹ç€æ¯å­çš„å‰©ä½™ç©ºé—´ï¼Œæ§åˆ¶å€’æ°´é€Ÿåº¦ â†’ åˆšåˆšå¥½ âœ…

TCPçš„æ»‘åŠ¨çª—å£å°±åƒè¿™ä¸ª"æ¯å­çš„å‰©ä½™ç©ºé—´"ï¼Œæ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹"æˆ‘è¿˜èƒ½æ¥æ”¶å¤šå°‘æ•°æ®"ï¼Œå‘é€æ–¹æ ¹æ®è¿™ä¸ªä¿¡æ¯æ§åˆ¶å‘é€é€Ÿåº¦ã€‚

---

## ğŸ¯ ä»Šæ—¥ç›®æ ‡

å­¦å®Œæœ¬ç« èŠ‚ï¼Œä½ å°†èƒ½å¤Ÿï¼š

- âœ… ç†è§£TCPæµé‡æ§åˆ¶çš„å¿…è¦æ€§
- âœ… æŒæ¡æ»‘åŠ¨çª—å£çš„å·¥ä½œåŸç†
- âœ… åŒºåˆ†å‘é€çª—å£å’Œæ¥æ”¶çª—å£
- âœ… ç†è§£é›¶çª—å£é—®é¢˜å’Œçª—å£æ¢æµ‹
- âœ… å®ç°ç®€å•çš„æ»‘åŠ¨çª—å£æ¨¡æ‹Ÿå™¨

---

## ğŸ“– ç†è®ºè®²è§£

### 1. ä¸ºä»€ä¹ˆéœ€è¦æµé‡æ§åˆ¶ï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼š
```
å‘é€æ–¹ï¼šé«˜æ€§èƒ½æœåŠ¡å™¨ï¼Œæ¯ç§’å¯å‘é€ 100MB
æ¥æ”¶æ–¹ï¼šä½æ€§èƒ½è®¾å¤‡ï¼Œæ¯ç§’åªèƒ½å¤„ç† 10MB

æ²¡æœ‰æµé‡æ§åˆ¶çš„åæœï¼š
- æ¥æ”¶æ–¹ç¼“å†²åŒºæº¢å‡º
- æ•°æ®ä¸¢å¤±
- æ€§èƒ½ä¸‹é™
```

**TCPæµé‡æ§åˆ¶çš„ç›®æ ‡**ï¼š
- âœ… é˜²æ­¢å‘é€æ–¹å‘é€è¿‡å¿«ï¼Œå¯¼è‡´æ¥æ”¶æ–¹ç¼“å†²åŒºæº¢å‡º
- âœ… è®©æ¥æ”¶æ–¹æ§åˆ¶å‘é€æ–¹çš„å‘é€é€Ÿåº¦
- âœ… æé«˜ä¼ è¾“æ•ˆç‡

**æ³¨æ„åŒºåˆ†**ï¼š
```
æµé‡æ§åˆ¶ï¼ˆFlow Controlï¼‰ï¼š
- ç›®çš„ï¼šé˜²æ­¢æ¥æ”¶æ–¹è¿‡è½½
- æœºåˆ¶ï¼šæ»‘åŠ¨çª—å£
- æ§åˆ¶è€…ï¼šæ¥æ”¶æ–¹

æ‹¥å¡æ§åˆ¶ï¼ˆCongestion Controlï¼‰ï¼š
- ç›®çš„ï¼šé˜²æ­¢ç½‘ç»œæ‹¥å¡
- æœºåˆ¶ï¼šæ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ç­‰
- æ§åˆ¶è€…ï¼šå‘é€æ–¹ï¼ˆæ˜å¤©å­¦ä¹ ï¼‰
```

---

### 2. æ»‘åŠ¨çª—å£åŸºæœ¬åŸç†

#### ä»€ä¹ˆæ˜¯çª—å£ï¼Ÿ

**çª—å£ï¼ˆWindowï¼‰**ï¼š
- å…è®¸å‘é€ä½†å°šæœªç¡®è®¤çš„æ•°æ®é‡
- ç”±æ¥æ”¶æ–¹é€šè¿‡TCPå¤´éƒ¨çš„çª—å£å­—æ®µå‘ŠçŸ¥å‘é€æ–¹
- å•ä½ï¼šå­—èŠ‚

**ä¸ºä»€ä¹ˆå«"æ»‘åŠ¨"çª—å£ï¼Ÿ**

```
å‘é€ç¼“å†²åŒºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·²å‘é€å·²ç¡®è®¤ â”‚ å·²å‘é€æœªç¡®è®¤ â”‚ å¯å‘é€ â”‚ ä¸å¯å‘é€ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â””â”€â”€â”€â”€â”€â”€ çª—å£ â”€â”€â”€â”€â”€â”€â”˜

æ”¶åˆ°ACKåï¼Œçª—å£å‘å³æ»‘åŠ¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·²å‘é€å·²ç¡®è®¤  â”‚ å·²å‘é€æœªç¡®è®¤ â”‚ å¯å‘é€ â”‚ ä¸å¯å‘é€ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â””â”€â”€â”€â”€â”€â”€ çª—å£ â”€â”€â”€â”€â”€â”€â”˜ â†’
```

---

### 3. å‘é€çª—å£è¯¦è§£

**å‘é€çª—å£çš„å››ä¸ªåŒºåŸŸ**ï¼š

```
å­—èŠ‚åºåˆ—å·ï¼š 1  2  3  4  5  6  7  8  9  10 11 12 13 14 15
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åŒºåŸŸ1ï¼š      [å·²å‘é€å·²ç¡®è®¤ ]
åŒºåŸŸ2ï¼š                     [å·²å‘é€æœªç¡®è®¤]
åŒºåŸŸ3ï¼š                                   [å¯å‘é€ ]
åŒºåŸŸ4ï¼š                                           [ä¸å¯å‘é€]
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            â†‘                â†‘           â†‘         â†‘
          SND.UNA        SND.NXT     SND.UNA+    çª—å£å³è¾¹ç•Œ
         (æœ€æ—©æœªç¡®è®¤)    (ä¸‹ä¸€ä¸ªå‘é€)  SND.WND
```

**å…³é”®æŒ‡é’ˆ**ï¼š

```
SND.UNAï¼ˆSend Unacknowledgedï¼‰ï¼š
- æœ€æ—©çš„æœªç¡®è®¤å­—èŠ‚åºåˆ—å·
- è¿™ä¹‹å‰çš„æ‰€æœ‰æ•°æ®éƒ½å·²ç¡®è®¤

SND.NXTï¼ˆSend Nextï¼‰ï¼š
- ä¸‹ä¸€ä¸ªè¦å‘é€çš„å­—èŠ‚åºåˆ—å·

SND.WNDï¼ˆSend Windowï¼‰ï¼š
- å‘é€çª—å£å¤§å°
- ç”±æ¥æ”¶æ–¹é€šå‘Š

å¯ç”¨çª—å£ = SND.UNA + SND.WND - SND.NXT
```

**ç¤ºä¾‹**ï¼š

```
å‡è®¾ï¼š
SND.UNA = 1000   ï¼ˆå­—èŠ‚1-999å·²ç¡®è®¤ï¼‰
SND.NXT = 1050   ï¼ˆå­—èŠ‚1000-1049å·²å‘é€ä½†æœªç¡®è®¤ï¼‰
SND.WND = 100    ï¼ˆçª—å£å¤§å°100å­—èŠ‚ï¼‰

è®¡ç®—ï¼š
çª—å£å³è¾¹ç•Œ = 1000 + 100 = 1100
å¯ç”¨çª—å£ = 1100 - 1050 = 50å­—èŠ‚
ï¼ˆè¿˜å¯ä»¥å‘é€50å­—èŠ‚ï¼‰

å‘é€ç¼“å†²åŒºçŠ¶æ€ï¼š
[1-999å·²ç¡®è®¤][1000-1049å·²å‘é€æœªç¡®è®¤][1050-1099å¯å‘é€][1100+ä¸å¯å‘é€]
                                        â””â”€ 50å­—èŠ‚ â”€â”˜
```

---

### 4. æ¥æ”¶çª—å£è¯¦è§£

**æ¥æ”¶çª—å£çš„ä¸‰ä¸ªåŒºåŸŸ**ï¼š

```
å­—èŠ‚åºåˆ—å·ï¼š 1  2  3  4  5  6  7  8  9  10 11 12 13
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åŒºåŸŸ1ï¼š      [å·²æ¥æ”¶å·²ç¡®è®¤]
åŒºåŸŸ2ï¼š                    [å¯æ¥æ”¶ ]
åŒºåŸŸ3ï¼š                              [ä¸å¯æ¥æ”¶]
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            â†‘               â†‘         â†‘
          RCV.NXT      RCV.NXT+    çª—å£å³è¾¹ç•Œ
        (æœŸæœ›æ¥æ”¶)      RCV.WND
```

**å…³é”®æŒ‡é’ˆ**ï¼š

```
RCV.NXTï¼ˆReceive Nextï¼‰ï¼š
- æœŸæœ›æ¥æ”¶çš„ä¸‹ä¸€ä¸ªå­—èŠ‚åºåˆ—å·
- å‘é€ç»™å¯¹æ–¹çš„ACKå€¼

RCV.WNDï¼ˆReceive Windowï¼‰ï¼š
- æ¥æ”¶çª—å£å¤§å°
- é€šè¿‡TCPå¤´éƒ¨å‘ŠçŸ¥å‘é€æ–¹
- ç­‰äºæ¥æ”¶ç¼“å†²åŒºçš„å‰©ä½™ç©ºé—´

RCV.WND = æ¥æ”¶ç¼“å†²åŒºå¤§å° - å·²æ¥æ”¶æœªè¯»å–çš„æ•°æ®é‡
```

---

### 5. æ»‘åŠ¨çª—å£å·¥ä½œæµç¨‹

**å®Œæ•´ç¤ºä¾‹**ï¼š

```
åˆå§‹çŠ¶æ€ï¼š
å‘é€æ–¹çª—å£ï¼š100å­—èŠ‚
æ¥æ”¶æ–¹çª—å£ï¼š100å­—èŠ‚

ã€æ­¥éª¤1ã€‘å‘é€æ–¹å‘é€50å­—èŠ‚ï¼ˆåºå·1-50ï¼‰
å‘é€æ–¹ï¼š
  SND.UNA = 1
  SND.NXT = 51ï¼ˆä¸‹ä¸€ä¸ªå‘é€ï¼‰
  SND.WND = 100
  å¯ç”¨çª—å£ = 1 + 100 - 51 = 50å­—èŠ‚

æ¥æ”¶æ–¹ï¼š
  RCV.NXT = 51ï¼ˆæœŸæœ›æ¥æ”¶51ï¼‰
  æ¥æ”¶ç¼“å†²åŒºï¼šå ç”¨50å­—èŠ‚
  RCV.WND = 100 - 50 = 50å­—èŠ‚ï¼ˆå‰©ä½™ç©ºé—´ï¼‰

ã€æ­¥éª¤2ã€‘æ¥æ”¶æ–¹å‘é€ACK=51ï¼Œçª—å£=50
  å‘Šè¯‰å‘é€æ–¹ï¼š"æˆ‘å·²ç»æ”¶åˆ°1-50ï¼ŒæœŸæœ›51ï¼Œæˆ‘è¿˜èƒ½æ¥æ”¶50å­—èŠ‚"

ã€æ­¥éª¤3ã€‘å‘é€æ–¹æ”¶åˆ°ACK
å‘é€æ–¹ï¼š
  SND.UNA = 51ï¼ˆçª—å£å‘å³æ»‘åŠ¨ï¼‰
  SND.WND = 50ï¼ˆæ›´æ–°çª—å£å¤§å°ï¼‰
  å¯ç”¨çª—å£ = 51 + 50 - 51 = 50å­—èŠ‚

ã€æ­¥éª¤4ã€‘åº”ç”¨å±‚è¯»å–æ•°æ®
æ¥æ”¶æ–¹ï¼š
  è¯»å–äº†30å­—èŠ‚
  æ¥æ”¶ç¼“å†²åŒºï¼šå ç”¨20å­—èŠ‚
  RCV.WND = 100 - 20 = 80å­—èŠ‚ï¼ˆç©ºé—´å¢åŠ ï¼ï¼‰

ã€æ­¥éª¤5ã€‘æ¥æ”¶æ–¹å‘é€çª—å£æ›´æ–°
  å‘é€ACK=51ï¼ˆæ•°æ®å·²ç¡®è®¤ï¼‰ï¼Œçª—å£=80
  å‘Šè¯‰å‘é€æ–¹ï¼š"æˆ‘çš„å¯ç”¨ç©ºé—´å¢åŠ åˆ°80å­—èŠ‚äº†"

ã€æ­¥éª¤6ã€‘å‘é€æ–¹ç»§ç»­å‘é€
  æ ¹æ®æ–°çš„çª—å£å¤§å°ç»§ç»­å‘é€æ•°æ®
```

---

### 6. é›¶çª—å£é—®é¢˜

#### ä»€ä¹ˆæ˜¯é›¶çª—å£ï¼Ÿ

**åœºæ™¯**ï¼š
```
æ¥æ”¶æ–¹å¤„ç†é€Ÿåº¦æ…¢ï¼Œç¼“å†²åŒºæ»¡äº†
â†’ å‘é€ACKï¼Œçª—å£=0
â†’ å‘Šè¯‰å‘é€æ–¹"åœæ­¢å‘é€"
```

**é—®é¢˜**ï¼š
```
æ¥æ”¶æ–¹ï¼šç¼“å†²åŒºæ»¡ â†’ å‘é€çª—å£=0
å‘é€æ–¹ï¼šæ”¶åˆ°çª—å£=0 â†’ åœæ­¢å‘é€

æ¥æ”¶æ–¹ï¼šåº”ç”¨è¯»å–æ•°æ® â†’ ç¼“å†²åŒºæœ‰ç©ºé—´äº† â†’ åº”è¯¥å‘é€çª—å£æ›´æ–°
ä½†æ˜¯ï¼šå¦‚æœçª—å£æ›´æ–°æŠ¥æ–‡ä¸¢å¤±äº†æ€ä¹ˆåŠï¼Ÿ
â†’ å‘é€æ–¹æ°¸è¿œç­‰å¾… âŒ
â†’ æ¥æ”¶æ–¹æ°¸è¿œç­‰å¾…å‘é€æ–¹å‘é€ âŒ
â†’ æ­»é”ï¼
```

#### çª—å£æ¢æµ‹æœºåˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼šå‘é€æ–¹ä¸ä¼šå‚»ç­‰ï¼Œä¼šä¸»åŠ¨æ¢æµ‹

**çª—å£æ¢æµ‹ï¼ˆWindow Probeï¼‰**ï¼š
```
å‘é€æ–¹æ”¶åˆ°é›¶çª—å£åï¼š
1. å¯åŠ¨æŒç»­è®¡æ—¶å™¨ï¼ˆPersist Timerï¼‰
2. å®šæœŸå‘é€çª—å£æ¢æµ‹æŠ¥æ–‡ï¼ˆ1å­—èŠ‚æ•°æ®ï¼‰
3. æ¥æ”¶æ–¹å¿…é¡»å›åº”å½“å‰çª—å£å¤§å°

æ¢æµ‹é—´éš”ï¼š
- åˆå§‹ï¼šé€šå¸¸å‡ ç§’
- é‡‡ç”¨æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s, 8s, ...
- æœ€å¤§é—´éš”ï¼š60ç§’
```

**ç¤ºä¾‹**ï¼š
```
æ—¶é—´çº¿ï¼š
t=0s:   æ¥æ”¶æ–¹å‘é€çª—å£=0
t=1s:   å‘é€æ–¹å‘é€æ¢æµ‹æŠ¥æ–‡ï¼ˆ1å­—èŠ‚ï¼‰
        æ¥æ”¶æ–¹å›åº”ï¼šACKï¼Œçª—å£=0ï¼ˆè¿˜æ˜¯æ²¡ç©ºé—´ï¼‰
t=3s:   å‘é€æ–¹å†æ¬¡å‘é€æ¢æµ‹æŠ¥æ–‡
        æ¥æ”¶æ–¹å›åº”ï¼šACKï¼Œçª—å£=0
t=7s:   å‘é€æ–¹å†æ¬¡å‘é€æ¢æµ‹æŠ¥æ–‡
        æ¥æ”¶æ–¹å›åº”ï¼šACKï¼Œçª—å£=500ï¼ˆæœ‰ç©ºé—´äº†ï¼ï¼‰
t=7s+:  å‘é€æ–¹ç»§ç»­å‘é€æ•°æ®
```

---

### 7. Silly Window Syndromeï¼ˆç³Šæ¶‚çª—å£ç»¼åˆç—‡ï¼‰

#### é—®é¢˜æè¿°

**æ¥æ”¶æ–¹å¼•èµ·çš„SWS**ï¼š
```
æ¥æ”¶æ–¹ï¼šæ¯æ¬¡åªè¯»å–1å­—èŠ‚ â†’ çª—å£å¢åŠ 1å­—èŠ‚
å‘é€æ–¹ï¼šæ”¶åˆ°çª—å£æ›´æ–° â†’ å‘é€1å­—èŠ‚æ•°æ®
ç»“æœï¼šå¤§é‡å°åŒ…ä¼ è¾“ï¼Œæ•ˆç‡æä½

ç¤ºä¾‹ï¼š
å‘é€1å­—èŠ‚æ•°æ®ï¼Œä½†TCP+IPå¤´éƒ¨=40å­—èŠ‚
æœ‰æ•ˆè½½è·æ¯”ä¾‹ = 1/41 = 2.4% âŒ
```

**å‘é€æ–¹å¼•èµ·çš„SWS**ï¼š
```
å‘é€æ–¹ï¼šåº”ç”¨å±‚æ¯æ¬¡åªå†™å…¥1å­—èŠ‚
å‘é€æ–¹ï¼šç«‹å³å‘é€1å­—èŠ‚æ•°æ®åŒ…
ç»“æœï¼šåŒæ ·é€ æˆå°åŒ…æ³›æ»¥
```

#### è§£å†³æ–¹æ¡ˆ

**æ¥æ”¶æ–¹çš„Clarkç®—æ³•**ï¼š
```python
# åªåœ¨ä»¥ä¸‹æƒ…å†µæ‰é€šå‘Šçª—å£å¢åŠ ï¼š
if æ–°çª—å£ >= min(MSS, æ¥æ”¶ç¼“å†²åŒº/2):
    å‘é€çª—å£æ›´æ–°
else:
    ç­‰å¾…æ›´å¤šç©ºé—´
```

**å‘é€æ–¹çš„Nagleç®—æ³•**ï¼š
```python
# å‘é€è§„åˆ™ï¼š
if æœ‰å…¨å°ºå¯¸æ®µï¼ˆMSSï¼‰çš„æ•°æ®:
    ç«‹å³å‘é€
elif æ²¡æœ‰æœªç¡®è®¤çš„æ•°æ®:
    ç«‹å³å‘é€
else:
    ç­‰å¾…æ›´å¤šæ•°æ®æˆ–ACKåˆ°è¾¾
```

**ç°ä»£å®è·µ**ï¼š
```
å¾ˆå¤šåº”ç”¨ç¦ç”¨Nagleç®—æ³•ï¼š
socket.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)

åŸå› ï¼š
- å®æ—¶åº”ç”¨éœ€è¦ä½å»¶è¿Ÿï¼ˆæ¸¸æˆã€è§†é¢‘ä¼šè®®ï¼‰
- ç°ä»£ç½‘ç»œå¸¦å®½å……è¶³
- åº”ç”¨å±‚è‡ªå·±æ§åˆ¶æ•°æ®å¤§å°
```

---

## ğŸ’» å®æˆ˜é¡¹ç›®ï¼šTCPæ»‘åŠ¨çª—å£æ¨¡æ‹Ÿå™¨

ä»Šå¤©æˆ‘ä»¬å®ç°ä¸€ä¸ªæ»‘åŠ¨çª—å£çš„æ¨¡æ‹Ÿå™¨ï¼Œç›´è§‚å±•ç¤ºçª—å£çš„å·¥ä½œè¿‡ç¨‹ã€‚

### é¡¹ç›®åŠŸèƒ½

1. **æ¨¡æ‹Ÿå‘é€çª—å£**ï¼šå±•ç¤ºçª—å£æ»‘åŠ¨è¿‡ç¨‹
2. **æ¨¡æ‹Ÿæ¥æ”¶çª—å£**ï¼šå±•ç¤ºç¼“å†²åŒºç®¡ç†
3. **é›¶çª—å£æ¼”ç¤º**ï¼šå±•ç¤ºçª—å£æ¢æµ‹æœºåˆ¶
4. **å¯è§†åŒ–æ˜¾ç¤º**ï¼šASCIIå›¾å½¢å±•ç¤ºçª—å£çŠ¶æ€

### ä»£ç å®ç°

```python
# day43_sliding_window_simulator.py
# åŠŸèƒ½ï¼šTCPæ»‘åŠ¨çª—å£æ¨¡æ‹Ÿå™¨

import time
from dataclasses import dataclass
from typing import List, Optional
from enum import Enum


class WindowState(Enum):
    """çª—å£çŠ¶æ€"""
    NORMAL = "æ­£å¸¸"
    ZERO = "é›¶çª—å£"
    PROBING = "çª—å£æ¢æµ‹"


@dataclass
class Segment:
    """TCPæ•°æ®æ®µ"""
    seq: int        # åºåˆ—å·
    size: int       # æ•°æ®å¤§å°
    data: str       # æ•°æ®å†…å®¹
    acked: bool = False  # æ˜¯å¦å·²ç¡®è®¤


class SendWindow:
    """å‘é€çª—å£"""

    def __init__(self, window_size: int = 100):
        """
        åˆå§‹åŒ–å‘é€çª—å£

        å‚æ•°è¯´æ˜ï¼š
            window_size: çª—å£å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        """
        self.snd_una = 1        # æœ€æ—©æœªç¡®è®¤å­—èŠ‚
        self.snd_nxt = 1        # ä¸‹ä¸€ä¸ªå‘é€å­—èŠ‚
        self.snd_wnd = window_size  # çª—å£å¤§å°
        self.segments: List[Segment] = []  # å·²å‘é€çš„æ®µ
        self.buffer = []        # å‘é€ç¼“å†²åŒº

    def can_send(self, size: int) -> bool:
        """
        æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘é€æŒ‡å®šå¤§å°çš„æ•°æ®

        å‚æ•°è¯´æ˜ï¼š
            size: è¦å‘é€çš„æ•°æ®å¤§å°

        è¿”å›å€¼ï¼š
            True/False
        """
        available = self.snd_una + self.snd_wnd - self.snd_nxt
        return available >= size

    def send(self, data: str, size: int) -> Optional[Segment]:
        """
        å‘é€æ•°æ®

        å‚æ•°è¯´æ˜ï¼š
            data: æ•°æ®å†…å®¹
            size: æ•°æ®å¤§å°

        è¿”å›å€¼ï¼š
            å‘é€çš„æ•°æ®æ®µï¼Œå¦‚æœæ— æ³•å‘é€åˆ™è¿”å›None
        """
        if not self.can_send(size):
            return None

        segment = Segment(seq=self.snd_nxt, size=size, data=data)
        self.segments.append(segment)
        self.snd_nxt += size
        return segment

    def receive_ack(self, ack: int, window: int):
        """
        æ¥æ”¶ACK

        å‚æ•°è¯´æ˜ï¼š
            ack: ç¡®è®¤å·
            window: æ–°çš„çª—å£å¤§å°

        å·¥ä½œåŸç†ï¼š
            æ›´æ–°SND.UNAï¼Œæ ‡è®°å·²ç¡®è®¤çš„æ®µï¼Œæ›´æ–°çª—å£å¤§å°
        """
        if ack > self.snd_una:
            # æ ‡è®°å·²ç¡®è®¤çš„æ®µ
            for seg in self.segments:
                if seg.seq < ack:
                    seg.acked = True

            # æ»‘åŠ¨çª—å£
            self.snd_una = ack

        # æ›´æ–°çª—å£å¤§å°
        self.snd_wnd = window

    def get_status(self) -> dict:
        """è·å–çª—å£çŠ¶æ€"""
        available = self.snd_una + self.snd_wnd - self.snd_nxt
        return {
            'snd_una': self.snd_una,
            'snd_nxt': self.snd_nxt,
            'snd_wnd': self.snd_wnd,
            'available': available,
            'in_flight': self.snd_nxt - self.snd_una  # å·²å‘é€æœªç¡®è®¤
        }

    def visualize(self):
        """å¯è§†åŒ–çª—å£çŠ¶æ€"""
        status = self.get_status()
        print(f"\nå‘é€çª—å£çŠ¶æ€ï¼š")
        print(f"  SND.UNA = {status['snd_una']} (æœ€æ—©æœªç¡®è®¤)")
        print(f"  SND.NXT = {status['snd_nxt']} (ä¸‹ä¸€ä¸ªå‘é€)")
        print(f"  SND.WND = {status['snd_wnd']} (çª—å£å¤§å°)")
        print(f"  å¯ç”¨çª—å£ = {status['available']} å­—èŠ‚")
        print(f"  åœ¨é€”æ•°æ® = {status['in_flight']} å­—èŠ‚")

        # ASCIIå¯è§†åŒ–
        print(f"\n  çª—å£å¯è§†åŒ–ï¼š")
        total = 50  # æ€»å®½åº¦
        una_pos = 0
        nxt_pos = min(int(status['in_flight'] / status['snd_wnd'] * total), total)
        wnd_end = total

        line = "  ["
        for i in range(total):
            if i < nxt_pos:
                line += "â–ˆ"  # å·²å‘é€æœªç¡®è®¤
            elif i < wnd_end:
                line += "â–‘"  # å¯å‘é€
            else:
                line += " "  # ä¸å¯å‘é€
        line += "]"
        print(line)
        print(f"   {'â†‘' + ' ' * nxt_pos}â†‘{' ' * (wnd_end - nxt_pos - 1)}â†‘")
        print(f"   UNA{' ' * (nxt_pos - 2)}NXT{' ' * (wnd_end - nxt_pos - 3)}è¾¹ç•Œ")


class ReceiveWindow:
    """æ¥æ”¶çª—å£"""

    def __init__(self, buffer_size: int = 100):
        """
        åˆå§‹åŒ–æ¥æ”¶çª—å£

        å‚æ•°è¯´æ˜ï¼š
            buffer_size: æ¥æ”¶ç¼“å†²åŒºå¤§å°
        """
        self.rcv_nxt = 1           # æœŸæœ›æ¥æ”¶çš„åºåˆ—å·
        self.buffer_size = buffer_size  # ç¼“å†²åŒºå¤§å°
        self.buffer_used = 0       # å·²ä½¿ç”¨çš„ç¼“å†²åŒº
        self.received: List[Segment] = []  # å·²æ¥æ”¶çš„æ•°æ®

    def receive(self, segment: Segment) -> Optional[int]:
        """
        æ¥æ”¶æ•°æ®æ®µ

        å‚æ•°è¯´æ˜ï¼š
            segment: æ•°æ®æ®µ

        è¿”å›å€¼ï¼š
            ACKå·ï¼Œå¦‚æœæ— æ³•æ¥æ”¶åˆ™è¿”å›None
        """
        available = self.buffer_size - self.buffer_used

        if segment.size > available:
            return None  # ç¼“å†²åŒºä¸è¶³

        if segment.seq == self.rcv_nxt:
            # æŒ‰åºåˆ°è¾¾
            self.received.append(segment)
            self.buffer_used += segment.size
            self.rcv_nxt += segment.size
            return self.rcv_nxt

        return None  # ä¹±åºï¼Œæš‚ä¸å¤„ç†

    def read_data(self, size: int) -> int:
        """
        åº”ç”¨å±‚è¯»å–æ•°æ®

        å‚æ•°è¯´æ˜ï¼š
            size: è¯»å–çš„æ•°æ®é‡

        è¿”å›å€¼ï¼š
            å®é™…è¯»å–çš„æ•°æ®é‡

        å·¥ä½œåŸç†ï¼š
            ä»ç¼“å†²åŒºè¯»å–æ•°æ®ï¼Œé‡Šæ”¾ç©ºé—´
        """
        actual_read = min(size, self.buffer_used)
        self.buffer_used -= actual_read
        return actual_read

    def get_window_size(self) -> int:
        """
        è·å–å½“å‰çª—å£å¤§å°

        è¿”å›å€¼ï¼š
            å¯ç”¨ç¼“å†²åŒºå¤§å°
        """
        return self.buffer_size - self.buffer_used

    def visualize(self):
        """å¯è§†åŒ–æ¥æ”¶çª—å£"""
        window = self.get_window_size()
        print(f"\næ¥æ”¶çª—å£çŠ¶æ€ï¼š")
        print(f"  RCV.NXT = {self.rcv_nxt} (æœŸæœ›æ¥æ”¶)")
        print(f"  ç¼“å†²åŒºå¤§å° = {self.buffer_size} å­—èŠ‚")
        print(f"  å·²ä½¿ç”¨ = {self.buffer_used} å­—èŠ‚")
        print(f"  å¯ç”¨çª—å£ = {window} å­—èŠ‚")

        # ASCIIå¯è§†åŒ–
        print(f"\n  ç¼“å†²åŒºå¯è§†åŒ–ï¼š")
        total = 50
        used_blocks = int(self.buffer_used / self.buffer_size * total)

        line = "  ["
        for i in range(total):
            if i < used_blocks:
                line += "â–ˆ"  # å·²ä½¿ç”¨
            else:
                line += "â–‘"  # å¯ç”¨
        line += "]"
        print(line)
        print(f"   {' ' * used_blocks}â†‘")
        print(f"   {' ' * used_blocks}å·²ç”¨{self.buffer_used}/{self.buffer_size}")


class SlidingWindowSimulator:
    """æ»‘åŠ¨çª—å£æ¨¡æ‹Ÿå™¨"""

    def __init__(self, window_size: int = 100, buffer_size: int = 100):
        """
        åˆå§‹åŒ–æ¨¡æ‹Ÿå™¨

        å‚æ•°è¯´æ˜ï¼š
            window_size: å‘é€çª—å£å¤§å°
            buffer_size: æ¥æ”¶ç¼“å†²åŒºå¤§å°
        """
        self.send_window = SendWindow(window_size)
        self.recv_window = ReceiveWindow(buffer_size)
        self.state = WindowState.NORMAL

    def simulate_normal_transfer(self):
        """
        æ¨¡æ‹Ÿæ­£å¸¸æ•°æ®ä¼ è¾“

        å·¥ä½œåŸç†ï¼š
            æ¼”ç¤ºå‘é€ã€ç¡®è®¤ã€çª—å£æ»‘åŠ¨çš„å®Œæ•´è¿‡ç¨‹
        """
        print("=" * 70)
        print("åœºæ™¯1ï¼šæ­£å¸¸æ•°æ®ä¼ è¾“")
        print("=" * 70)

        steps = [
            (30, "ç¬¬ä¸€æ‰¹æ•°æ®", 0),
            (20, "ç¬¬äºŒæ‰¹æ•°æ®", 0),
            (0, None, 30),  # è¯»å–30å­—èŠ‚
            (50, "ç¬¬ä¸‰æ‰¹æ•°æ®", 0),
        ]

        for i, (send_size, data, read_size) in enumerate(steps, 1):
            print(f"\nã€æ­¥éª¤{i}ã€‘")

            if send_size > 0:
                # å‘é€æ•°æ®
                seg = self.send_window.send(data, send_size)
                if seg:
                    print(f"å‘é€ {send_size} å­—èŠ‚ï¼š{data}")
                    self.send_window.visualize()

                    # æ¥æ”¶æ•°æ®
                    ack = self.recv_window.receive(seg)
                    if ack:
                        print(f"\næ¥æ”¶æˆåŠŸï¼Œå‘é€ACK={ack}")
                        self.recv_window.visualize()

                        # å‘é€ACK
                        window = self.recv_window.get_window_size()
                        self.send_window.receive_ack(ack, window)
                        print(f"\nå‘é€æ–¹æ”¶åˆ°ACKï¼Œçª—å£æ›´æ–°ä¸º{window}")

            if read_size > 0:
                # åº”ç”¨å±‚è¯»å–
                actual = self.recv_window.read_data(read_size)
                print(f"åº”ç”¨å±‚è¯»å– {actual} å­—èŠ‚")
                self.recv_window.visualize()

                # å‘é€çª—å£æ›´æ–°
                window = self.recv_window.get_window_size()
                ack = self.recv_window.rcv_nxt
                self.send_window.receive_ack(ack, window)
                print(f"\nå‘é€çª—å£æ›´æ–°é€šçŸ¥ï¼Œæ–°çª—å£={window}")

            time.sleep(0.5)

    def simulate_zero_window(self):
        """
        æ¨¡æ‹Ÿé›¶çª—å£åœºæ™¯

        å·¥ä½œåŸç†ï¼š
            æ¼”ç¤ºæ¥æ”¶ç¼“å†²åŒºæ»¡ã€é›¶çª—å£ã€çª—å£æ¢æµ‹çš„è¿‡ç¨‹
        """
        print("\n" + "=" * 70)
        print("åœºæ™¯2ï¼šé›¶çª—å£å’Œçª—å£æ¢æµ‹")
        print("=" * 70)

        print("\nã€æ­¥éª¤1ã€‘å¡«æ»¡æ¥æ”¶ç¼“å†²åŒº")
        # å‘é€æ•°æ®ç›´åˆ°ç¼“å†²åŒºæ»¡
        while self.recv_window.get_window_size() > 0:
            size = min(20, self.recv_window.get_window_size())
            seg = self.send_window.send(f"æ•°æ®{size}", size)
            if seg:
                ack = self.recv_window.receive(seg)
                if ack:
                    window = self.recv_window.get_window_size()
                    self.send_window.receive_ack(ack, window)

        print(f"æ¥æ”¶ç¼“å†²åŒºå·²æ»¡ï¼")
        self.recv_window.visualize()
        print(f"\nçª—å£å¤§å° = {self.recv_window.get_window_size()} ï¼ˆé›¶çª—å£ï¼ï¼‰")
        self.state = WindowState.ZERO

        print("\nã€æ­¥éª¤2ã€‘å‘é€æ–¹æ”¶åˆ°é›¶çª—å£")
        print("å‘é€æ–¹åœæ­¢å‘é€ï¼Œå¯åŠ¨æŒç»­è®¡æ—¶å™¨")
        self.send_window.visualize()

        print("\nã€æ­¥éª¤3ã€‘çª—å£æ¢æµ‹")
        self.state = WindowState.PROBING
        for i in range(3):
            print(f"\næ¢æµ‹ #{i+1}ï¼šå‘é€1å­—èŠ‚æ¢æµ‹æŠ¥æ–‡")
            window = self.recv_window.get_window_size()
            print(f"æ¥æ”¶æ–¹å›åº”ï¼šçª—å£ = {window}")
            time.sleep(0.3)

        print("\nã€æ­¥éª¤4ã€‘åº”ç”¨å±‚è¯»å–æ•°æ®")
        read_size = 50
        actual = self.recv_window.read_data(read_size)
        print(f"åº”ç”¨å±‚è¯»å– {actual} å­—èŠ‚")
        self.recv_window.visualize()

        print("\nã€æ­¥éª¤5ã€‘çª—å£æ¢å¤")
        window = self.recv_window.get_window_size()
        ack = self.recv_window.rcv_nxt
        self.send_window.receive_ack(ack, window)
        print(f"å‘é€çª—å£æ›´æ–°ï¼šçª—å£ = {window}")
        print("æ¢å¤æ­£å¸¸å‘é€ï¼")
        self.state = WindowState.NORMAL


def main():
    """
    ä¸»å‡½æ•°ï¼šæ¼”ç¤ºTCPæ»‘åŠ¨çª—å£
    """
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        TCPæµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£ï¼‰- Day 43 å®æˆ˜é¡¹ç›®             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

    # åˆ›å»ºæ¨¡æ‹Ÿå™¨
    simulator = SlidingWindowSimulator(window_size=100, buffer_size=100)

    # åœºæ™¯1ï¼šæ­£å¸¸ä¼ è¾“
    simulator.simulate_normal_transfer()

    # åœºæ™¯2ï¼šé›¶çª—å£
    simulator.simulate_zero_window()

    print("""
\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ æ ¸å¿ƒè¦ç‚¹æ€»ç»“ï¼š

1. æ»‘åŠ¨çª—å£æ§åˆ¶å‘é€é€Ÿåº¦ï¼Œé˜²æ­¢æ¥æ”¶æ–¹è¿‡è½½
2. çª—å£å¤§å° = æ¥æ”¶ç¼“å†²åŒºçš„å¯ç”¨ç©ºé—´
3. çª—å£ä¼šéšç€æ•°æ®ç¡®è®¤å’Œåº”ç”¨è¯»å–è€Œ"æ»‘åŠ¨"
4. é›¶çª—å£æ—¶ï¼Œå‘é€æ–¹ä¼šå®šæœŸå‘é€æ¢æµ‹æŠ¥æ–‡
5. çª—å£å¤§å°ç›´æ¥å½±å“ä¼ è¾“æ•ˆç‡

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")


if __name__ == "__main__":
    main()
