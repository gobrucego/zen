# Day 42: TCPå››æ¬¡æŒ¥æ‰‹å’ŒçŠ¶æ€æœº

## ğŸ“š ä»Šæ—¥å¯¼è¯­

æ˜¨å¤©æˆ‘ä»¬å­¦ä¹ äº†TCPå¦‚ä½•"æ‰“æ‹›å‘¼"ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰ï¼Œä»Šå¤©æˆ‘ä»¬è¦å­¦ä¹ TCPå¦‚ä½•"è¯´å†è§"ï¼ˆå››æ¬¡æŒ¥æ‰‹ï¼‰ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
å››æ¬¡æŒ¥æ‰‹å°±åƒæ‰“ç”µè¯ç»“æŸé€šè¯ï¼š
1. **ç¬¬ä¸€æ¬¡**ï¼šä½ è¯´"æˆ‘è¿™è¾¹è¯´å®Œäº†ï¼Œå¯ä»¥æŒ‚äº†"ï¼ˆFINï¼‰
2. **ç¬¬äºŒæ¬¡**ï¼šå¯¹æ–¹è¯´"å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†"ï¼ˆACKï¼‰
3. **ç¬¬ä¸‰æ¬¡**ï¼šå¯¹æ–¹è¯´"æˆ‘è¿™è¾¹ä¹Ÿè¯´å®Œäº†ï¼Œå¯ä»¥æŒ‚äº†"ï¼ˆFINï¼‰
4. **ç¬¬å››æ¬¡**ï¼šä½ è¯´"å¥½çš„ï¼Œå†è§ï¼"ï¼ˆACKï¼‰

ä¸ºä»€ä¹ˆéœ€è¦å››æ¬¡ï¼Ÿå› ä¸ºTCPæ˜¯å…¨åŒå·¥é€šä¿¡ï¼ŒåŒæ–¹éƒ½éœ€è¦ç¡®è®¤è‡ªå·±çš„æ•°æ®ä¼ è¾“å®Œæˆäº†ã€‚

---

## ğŸ¯ ä»Šæ—¥ç›®æ ‡

å­¦å®Œæœ¬ç« èŠ‚ï¼Œä½ å°†èƒ½å¤Ÿï¼š

- âœ… ç†è§£TCPå››æ¬¡æŒ¥æ‰‹çš„å®Œæ•´æµç¨‹
- âœ… æŒæ¡TCPå®Œæ•´çš„11ç§çŠ¶æ€
- âœ… ç†è§£TIME_WAITçŠ¶æ€çš„ä½œç”¨
- âœ… è¯†åˆ«å„ç§å¼‚å¸¸å…³é—­æƒ…å†µ
- âœ… ä½¿ç”¨å·¥å…·ç›‘æ§TCPè¿æ¥ç”Ÿå‘½å‘¨æœŸ

---

## ğŸ“– ç†è®ºè®²è§£

### 1. TCPå››æ¬¡æŒ¥æ‰‹è¯¦ç»†æµç¨‹

```
å®¢æˆ·ç«¯                                    æœåŠ¡å™¨
  |          ESTABLISHED                    |
  |                                         |
  |  â‘   FIN=1, seq=u                       |
  |---------------------------------------->|  (æœåŠ¡å™¨è¿›å…¥CLOSE_WAIT)
  |          FIN_WAIT_1                     |
  |                                         |
  |  â‘¡  ACK=1, ack=u+1                     |
  |<----------------------------------------|
  |          FIN_WAIT_2                     |
  |                                         |
  |          ç­‰å¾…æœåŠ¡å™¨å…³é—­...              |
  |                                         |
  |  â‘¢  FIN=1, ACK=1, seq=v, ack=u+1      |
  |<----------------------------------------|  (æœåŠ¡å™¨å‘é€FIN)
  |                                         |  LAST_ACK
  |  â‘£  ACK=1, ack=v+1                     |
  |---------------------------------------->|  CLOSED
  |          TIME_WAIT (2MSL)               |
  |                                         |
  â–¼          CLOSED                         â–¼
```

---

#### ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼ˆä¸»åŠ¨å…³é—­æ–¹ â†’ è¢«åŠ¨å…³é—­æ–¹ï¼‰

**å‘é€æ–¹**ï¼š
- FIN = 1ï¼ˆç»“æŸæ ‡å¿—ä½ï¼Œè¡¨ç¤ºè¯·æ±‚å…³é—­è¿æ¥ï¼‰
- seq = uï¼ˆåºåˆ—å·ï¼‰

**çŠ¶æ€å˜åŒ–**ï¼š
- ä¸»åŠ¨æ–¹ï¼šESTABLISHED â†’ FIN_WAIT_1
- è¢«åŠ¨æ–¹ï¼šESTABLISHED â†’ CLOSE_WAITï¼ˆæ”¶åˆ°FINåï¼‰

**å«ä¹‰**ï¼š
"æˆ‘çš„æ•°æ®å·²ç»å‘é€å®Œäº†ï¼Œå‡†å¤‡å…³é—­å‘é€é€šé“"

---

#### ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼ˆè¢«åŠ¨å…³é—­æ–¹ â†’ ä¸»åŠ¨å…³é—­æ–¹ï¼‰

**å‘é€æ–¹**ï¼š
- ACK = 1
- ack = u + 1

**çŠ¶æ€å˜åŒ–**ï¼š
- ä¸»åŠ¨æ–¹ï¼šFIN_WAIT_1 â†’ FIN_WAIT_2ï¼ˆæ”¶åˆ°ACKåï¼‰
- è¢«åŠ¨æ–¹ï¼šä¿æŒCLOSE_WAIT

**å«ä¹‰**ï¼š
"æˆ‘çŸ¥é“ä½ è¦å…³é—­äº†ï¼Œä½†æˆ‘å¯èƒ½è¿˜æœ‰æ•°æ®è¦å‘é€ï¼Œè¯·ç¨ç­‰"

**é‡è¦**ï¼šæ­¤æ—¶è¿æ¥å¤„äºåŠå…³é—­çŠ¶æ€
- ä¸»åŠ¨æ–¹ â†’ è¢«åŠ¨æ–¹ï¼šå·²å…³é—­ï¼ˆä¸èƒ½å†å‘é€æ•°æ®ï¼‰
- è¢«åŠ¨æ–¹ â†’ ä¸»åŠ¨æ–¹ï¼šä»ç„¶æ‰“å¼€ï¼ˆå¯ä»¥ç»§ç»­å‘é€æ•°æ®ï¼‰

---

#### ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼ˆè¢«åŠ¨å…³é—­æ–¹ â†’ ä¸»åŠ¨å…³é—­æ–¹ï¼‰

**å‘é€æ–¹**ï¼š
- FIN = 1
- ACK = 1
- seq = v
- ack = u + 1

**çŠ¶æ€å˜åŒ–**ï¼š
- è¢«åŠ¨æ–¹ï¼šCLOSE_WAIT â†’ LAST_ACK
- ä¸»åŠ¨æ–¹ï¼šä»åœ¨FIN_WAIT_2

**å«ä¹‰**ï¼š
"æˆ‘çš„æ•°æ®ä¹Ÿå‘é€å®Œäº†ï¼Œå¯ä»¥å…³é—­è¿æ¥äº†"

---

#### ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼ˆä¸»åŠ¨å…³é—­æ–¹ â†’ è¢«åŠ¨å…³é—­æ–¹ï¼‰

**å‘é€æ–¹**ï¼š
- ACK = 1
- ack = v + 1

**çŠ¶æ€å˜åŒ–**ï¼š
- ä¸»åŠ¨æ–¹ï¼šFIN_WAIT_2 â†’ TIME_WAIT â†’ CLOSED
- è¢«åŠ¨æ–¹ï¼šLAST_ACK â†’ CLOSEDï¼ˆæ”¶åˆ°ACKåï¼‰

**å«ä¹‰**ï¼š
"å¥½çš„ï¼Œç¡®è®¤å…³é—­"

---

### 2. ä¸ºä»€ä¹ˆæ˜¯å››æ¬¡æŒ¥æ‰‹è€Œä¸æ˜¯ä¸‰æ¬¡ï¼Ÿ

**é—®é¢˜**ï¼šç¬¬äºŒæ¬¡å’Œç¬¬ä¸‰æ¬¡èƒ½å¦åˆå¹¶ï¼Ÿ

**ç­”æ¡ˆ**ï¼šé€šå¸¸ä¸èƒ½ï¼Œå› ä¸ºï¼š

```
ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼ˆACKï¼‰ï¼š
- æœåŠ¡å™¨ç¡®è®¤æ”¶åˆ°å®¢æˆ·ç«¯çš„FIN
- ä½†æœåŠ¡å™¨å¯èƒ½è¿˜æœ‰æ•°æ®è¦å‘é€

[æœåŠ¡å™¨ç»§ç»­å‘é€æ•°æ®...]

ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼ˆFINï¼‰ï¼š
- æœåŠ¡å™¨æ•°æ®å‘é€å®Œæˆ
- æ‰å‘é€è‡ªå·±çš„FIN
```

**ç‰¹æ®Šæƒ…å†µ**ï¼šå¦‚æœæœåŠ¡å™¨æ²¡æœ‰æ•°æ®è¦å‘é€ï¼Œå¯ä»¥åˆå¹¶ä¸ºä¸‰æ¬¡æŒ¥æ‰‹ï¼š
```
å®¢æˆ·ç«¯ â†’ FIN        â†’ æœåŠ¡å™¨
å®¢æˆ·ç«¯ â† FIN+ACK    â† æœåŠ¡å™¨ï¼ˆåˆå¹¶äº†ç¬¬äºŒæ¬¡å’Œç¬¬ä¸‰æ¬¡ï¼‰
å®¢æˆ·ç«¯ â†’ ACK        â†’ æœåŠ¡å™¨
```

---

### 3. TCPå®Œæ•´çŠ¶æ€æœºï¼ˆ11ç§çŠ¶æ€ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLOSED  â”‚ â† åˆå§‹çŠ¶æ€ï¼Œæ— è¿æ¥
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ è¢«åŠ¨æ‰“å¼€ï¼ˆæœåŠ¡å™¨ï¼‰
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LISTEN  â”‚ â† ç›‘å¬çŠ¶æ€ï¼Œç­‰å¾…è¿æ¥
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ æ”¶åˆ°SYN
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚SYN_RCVD  â”‚ â† æ”¶åˆ°è¿æ¥è¯·æ±‚ï¼Œç­‰å¾…ç¡®è®¤
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ æ”¶åˆ°ACK
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ESTABLISHED â”‚ â† è¿æ¥å»ºç«‹            â”‚ SYN_SENT â”‚ â† ä¸»åŠ¨æ‰“å¼€ï¼ˆå®¢æˆ·ç«¯ï¼‰
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚                                  â”‚
      â”‚ ä¸»åŠ¨å…³é—­ï¼ˆå‘é€FINï¼‰              â”‚ æ”¶åˆ°SYN-ACK
      â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      è¿”å›ESTABLISHED
â”‚ FIN_WAIT_1 â”‚ â† ç­‰å¾…å¯¹æ–¹ç¡®è®¤å…³é—­
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ æ”¶åˆ°ACK
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FIN_WAIT_2 â”‚ â† ç­‰å¾…å¯¹æ–¹å‘é€FIN
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ æ”¶åˆ°FIN
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIME_WAIT  â”‚ â† ç­‰å¾…2MSLï¼Œç¡®ä¿å¯¹æ–¹æ”¶åˆ°ACK
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ è¶…æ—¶
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLOSED  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¢«åŠ¨å…³é—­æ–¹çŠ¶æ€ï¼š
ESTABLISHED â†’ CLOSE_WAIT â†’ LAST_ACK â†’ CLOSED
```

#### 11ç§çŠ¶æ€è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€       â”‚ è¯´æ˜                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CLOSED     â”‚ å…³é—­çŠ¶æ€ï¼Œæ— è¿æ¥                 â”‚
â”‚ LISTEN     â”‚ ç›‘å¬çŠ¶æ€ï¼Œç­‰å¾…è¿æ¥è¯·æ±‚           â”‚
â”‚ SYN_SENT   â”‚ å‘é€SYNåï¼Œç­‰å¾…åŒ¹é…çš„SYN         â”‚
â”‚ SYN_RCVD   â”‚ æ”¶åˆ°SYNåï¼Œç­‰å¾…ACK               â”‚
â”‚ ESTABLISHEDâ”‚ è¿æ¥å·²å»ºç«‹ï¼Œå¯ä»¥ä¼ è¾“æ•°æ®         â”‚
â”‚ FIN_WAIT_1 â”‚ ä¸»åŠ¨å…³é—­ï¼Œç­‰å¾…FINçš„ACK           â”‚
â”‚ FIN_WAIT_2 â”‚ æ”¶åˆ°ACKï¼Œç­‰å¾…å¯¹æ–¹çš„FIN           â”‚
â”‚ CLOSE_WAIT â”‚ è¢«åŠ¨å…³é—­ï¼Œç­‰å¾…æœ¬åœ°åº”ç”¨å…³é—­       â”‚
â”‚ CLOSING    â”‚ åŒæ–¹åŒæ—¶å…³é—­ï¼Œç­‰å¾…ACK            â”‚
â”‚ LAST_ACK   â”‚ å‘é€FINåï¼Œç­‰å¾…æœ€åçš„ACK         â”‚
â”‚ TIME_WAIT  â”‚ ç­‰å¾…2MSLï¼Œç¡®ä¿è¿æ¥å½»åº•å…³é—­       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. TIME_WAITçŠ¶æ€è¯¦è§£

**TIME_WAITæ˜¯ä»€ä¹ˆï¼Ÿ**
- ä¸»åŠ¨å…³é—­æ–¹åœ¨å‘é€æœ€åä¸€ä¸ªACKåè¿›å…¥çš„çŠ¶æ€
- æŒç»­æ—¶é—´ï¼š2MSLï¼ˆMaximum Segment Lifetimeï¼Œæœ€å¤§æŠ¥æ–‡ç”Ÿå­˜æ—¶é—´ï¼‰
- é€šå¸¸ï¼š2MSL = 2 Ã— 2åˆ†é’Ÿ = 4åˆ†é’Ÿ

**ä¸ºä»€ä¹ˆéœ€è¦TIME_WAITï¼Ÿ**

**åŸå› 1ï¼šç¡®ä¿æœ€åçš„ACKåˆ°è¾¾**
```
å¦‚æœæ²¡æœ‰TIME_WAITï¼š
å®¢æˆ·ç«¯ â†’ ACKï¼ˆç¬¬å››æ¬¡æŒ¥æ‰‹ï¼‰ â†’ æœåŠ¡å™¨
                             æœåŠ¡å™¨ï¼šç­‰å¾…ACKè¶…æ—¶
                             æœåŠ¡å™¨ï¼šé‡å‘FIN

å®¢æˆ·ç«¯å·²ç»å…³é—­ï¼Œæ”¶ä¸åˆ°é‡å‘çš„FIN â†’ è¿æ¥å¼‚å¸¸

æœ‰TIME_WAITï¼š
å®¢æˆ·ç«¯åœ¨TIME_WAITçŠ¶æ€ â†’ å¯ä»¥æ¥æ”¶é‡å‘çš„FIN
                       â†’ é‡å‘ACK
```

**åŸå› 2ï¼šé˜²æ­¢æ—§è¿æ¥æ•°æ®å¹²æ‰°æ–°è¿æ¥**
```
TIME_WAITæœŸé—´ï¼Œä¸ä¼šå¤ç”¨ç›¸åŒçš„(æºIP, æºç«¯å£, ç›®æ ‡IP, ç›®æ ‡ç«¯å£)
ç¡®ä¿æ—§è¿æ¥çš„å»¶è¿Ÿæ•°æ®ä¸ä¼šå½±å“æ–°è¿æ¥
```

**TIME_WAITçš„é—®é¢˜**

**é—®é¢˜**ï¼šå¤§é‡TIME_WAITè¿æ¥å ç”¨èµ„æº

**åœºæ™¯**ï¼š
- é«˜å¹¶å‘æœåŠ¡å™¨ä¸»åŠ¨å…³é—­å¤§é‡è¿æ¥
- çŸ­è¿æ¥é¢‘ç¹å»ºç«‹å’Œå…³é—­

**æŸ¥çœ‹TIME_WAITè¿æ¥**ï¼š
```bash
# Linux
netstat -ant | grep TIME_WAIT | wc -l

# æŸ¥çœ‹æ¯ä¸ªçŠ¶æ€çš„è¿æ¥æ•°
netstat -ant | awk '{print $6}' | sort | uniq -c
```

**è§£å†³æ–¹æ³•**ï¼š
```bash
# 1. å¯ç”¨TIME_WAITå¿«é€Ÿå›æ”¶ï¼ˆLinuxï¼‰
sysctl -w net.ipv4.tcp_tw_reuse=1

# 2. å¯ç”¨TIME_WAITå¿«é€Ÿå›æ”¶ï¼ˆæ…ç”¨ï¼‰
sysctl -w net.ipv4.tcp_tw_recycle=1

# 3. å¢åŠ æœ¬åœ°ç«¯å£èŒƒå›´
sysctl -w net.ipv4.ip_local_port_range="1024 65535"

# 4. å‡å°‘TIME_WAITæ—¶é—´ï¼ˆä¸æ¨èï¼‰
# ä¿®æ”¹å†…æ ¸å‚æ•°
```

---

### 5. å¼‚å¸¸å…³é—­æƒ…å†µ

#### æƒ…å†µ1ï¼šRSTå¼ºåˆ¶å…³é—­

**æ­£å¸¸å…³é—­**ï¼šFINï¼ˆä¼˜é›…å…³é—­ï¼‰
**å¼‚å¸¸å…³é—­**ï¼šRSTï¼ˆå¼ºåˆ¶å…³é—­ï¼Œç«‹å³ä¸­æ–­ï¼‰

**è§¦å‘RSTçš„æƒ…å†µ**ï¼š
```
1. è¿æ¥ä¸å­˜åœ¨çš„ç«¯å£
   å®¢æˆ·ç«¯ â†’ SYN â†’ æœåŠ¡å™¨ï¼ˆç«¯å£æœªå¼€æ”¾ï¼‰
   å®¢æˆ·ç«¯ â† RST â† æœåŠ¡å™¨

2. è¿æ¥å·²å…³é—­ï¼Œæ”¶åˆ°æ•°æ®
   å®¢æˆ·ç«¯ â†’ æ•°æ® â†’ æœåŠ¡å™¨ï¼ˆè¿æ¥å·²å…³é—­ï¼‰
   å®¢æˆ·ç«¯ â† RST â† æœåŠ¡å™¨

3. å¼‚å¸¸ç»ˆæ­¢ç¨‹åº
   ç¨‹åºå´©æºƒ â†’ å‘é€RSTï¼ˆè€ŒéFINï¼‰

4. SO_LINGERé€‰é¡¹
   socket.setsockopt(SOL_SOCKET, SO_LINGER, (1, 0))
   â†’ å…³é—­æ—¶å‘é€RSTè€ŒéFIN
```

#### æƒ…å†µ2ï¼šCLOSE_WAITå †ç§¯

**é—®é¢˜ç°è±¡**ï¼š
```bash
netstat -ant | grep CLOSE_WAIT | wc -l
# è¾“å‡ºï¼š10000+ï¼ˆå¤§é‡CLOSE_WAITï¼‰
```

**åŸå› **ï¼š
```
æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„FIN â†’ è¿›å…¥CLOSE_WAIT
ä½†åº”ç”¨ç¨‹åºæ²¡æœ‰è°ƒç”¨close() â†’ ä¸€ç›´åœç•™åœ¨CLOSE_WAIT
```

**å…¸å‹åœºæ™¯**ï¼š
```python
# é”™è¯¯ç¤ºä¾‹
sock, addr = server_socket.accept()
data = sock.recv(1024)
# å¤„ç†æ•°æ®...
# å¿˜è®°è°ƒç”¨ sock.close()  â† å¯¼è‡´CLOSE_WAITå †ç§¯
```

**è§£å†³æ–¹æ³•**ï¼š
```python
# æ­£ç¡®ç¤ºä¾‹1ï¼šä½¿ç”¨try-finally
sock, addr = server_socket.accept()
try:
    data = sock.recv(1024)
    # å¤„ç†æ•°æ®...
finally:
    sock.close()  # ç¡®ä¿å…³é—­

# æ­£ç¡®ç¤ºä¾‹2ï¼šä½¿ç”¨withè¯­å¥
with socket.socket() as sock:
    # ä½¿ç”¨socket
    pass  # è‡ªåŠ¨å…³é—­
```

#### æƒ…å†µ3ï¼šåŠå…³é—­çŠ¶æ€

**ä»€ä¹ˆæ˜¯åŠå…³é—­ï¼Ÿ**
```
å®¢æˆ·ç«¯å…³é—­å‘é€é€šé“ï¼ˆä¸èƒ½å†å‘é€ï¼‰
ä½†ä¿æŒæ¥æ”¶é€šé“ï¼ˆä»å¯æ¥æ”¶ï¼‰
```

**åº”ç”¨åœºæ™¯**ï¼š
```python
# å®¢æˆ·ç«¯å‘é€å®Œæ•°æ®å
sock.shutdown(socket.SHUT_WR)  # å…³é—­å†™ï¼ˆå‘é€FINï¼‰
# ä½†ä»å¯ä»¥æ¥æ”¶æœåŠ¡å™¨çš„å“åº”
response = sock.recv(1024)
sock.close()
```

---

## ğŸ’» å®æˆ˜é¡¹ç›®ï¼šTCPè¿æ¥ç”Ÿå‘½å‘¨æœŸç›‘æ§å·¥å…·

ä»Šå¤©æˆ‘ä»¬å®ç°ä¸€ä¸ªå·¥å…·ï¼Œç›‘æ§TCPè¿æ¥çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä»å»ºç«‹åˆ°å…³é—­ã€‚

### é¡¹ç›®åŠŸèƒ½

1. **æ¨¡æ‹Ÿå››æ¬¡æŒ¥æ‰‹**ï¼šæ¼”ç¤ºå®Œæ•´çš„å…³é—­æµç¨‹
2. **çŠ¶æ€è·Ÿè¸ª**ï¼šè·Ÿè¸ªTCPçŠ¶æ€å˜åŒ–
3. **TIME_WAITç›‘æ§**ï¼šè§‚å¯ŸTIME_WAITçŠ¶æ€
4. **å¼‚å¸¸æ£€æµ‹**ï¼šæ£€æµ‹CLOSE_WAITç­‰å¼‚å¸¸

### ä»£ç å®ç°

```python
# day42_tcp_lifecycle_monitor.py
# åŠŸèƒ½ï¼šTCPè¿æ¥ç”Ÿå‘½å‘¨æœŸç›‘æ§å·¥å…·

import socket
import time
import subprocess
import platform
from dataclasses import dataclass
from typing import List, Dict, Optional
from enum import Enum


class TCPState(Enum):
    """TCPçŠ¶æ€æšä¸¾"""
    CLOSED = "CLOSED"
    LISTEN = "LISTEN"
    SYN_SENT = "SYN_SENT"
    SYN_RCVD = "SYN_RCVD"
    ESTABLISHED = "ESTABLISHED"
    FIN_WAIT_1 = "FIN_WAIT_1"
    FIN_WAIT_2 = "FIN_WAIT_2"
    CLOSE_WAIT = "CLOSE_WAIT"
    CLOSING = "CLOSING"
    LAST_ACK = "LAST_ACK"
    TIME_WAIT = "TIME_WAIT"


@dataclass
class TCPConnection:
    """TCPè¿æ¥ä¿¡æ¯"""
    local_addr: str
    local_port: int
    remote_addr: str
    remote_port: int
    state: TCPState
    pid: Optional[int] = None


class WavehandSimulator:
    """å››æ¬¡æŒ¥æ‰‹æ¨¡æ‹Ÿå™¨"""

    def __init__(self):
        self.client_state = TCPState.ESTABLISHED
        self.server_state = TCPState.ESTABLISHED
        self.client_seq = 1000
        self.server_seq = 2000

    def simulate_close(self, verbose: bool = True):
        """
        æ¨¡æ‹Ÿå®Œæ•´çš„å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹

        å‚æ•°è¯´æ˜ï¼š
            verbose: æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

        å·¥ä½œåŸç†ï¼š
            æŒ‰ç…§TCPåè®®è§„èŒƒï¼Œæ¨¡æ‹Ÿå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„æŒ¥æ‰‹äº¤äº’
        """
        if verbose:
            print("=" * 70)
            print("TCPå››æ¬¡æŒ¥æ‰‹æ¨¡æ‹Ÿ")
            print("=" * 70)
            print()
            print("åˆå§‹çŠ¶æ€ï¼šåŒæ–¹éƒ½å¤„äºESTABLISHEDçŠ¶æ€")
            print(f"  å®¢æˆ·ç«¯: {self.client_state.value}")
            print(f"  æœåŠ¡å™¨: {self.server_state.value}")
            print()

        # ç¬¬ä¸€æ¬¡æŒ¥æ‰‹
        self._first_wave(verbose)
        time.sleep(0.1)

        # ç¬¬äºŒæ¬¡æŒ¥æ‰‹
        self._second_wave(verbose)
        time.sleep(0.1)

        # ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹
        self._third_wave(verbose)
        time.sleep(0.1)

        # ç¬¬å››æ¬¡æŒ¥æ‰‹
        self._fourth_wave(verbose)
        time.sleep(0.1)

        # TIME_WAIT
        self._time_wait(verbose)

        if verbose:
            print("\n" + "=" * 70)
            print("âœ… è¿æ¥å…³é—­å®Œæˆï¼")
            print("=" * 70)

    def _first_wave(self, verbose: bool):
        """ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ (FIN)"""
        self.client_state = TCPState.FIN_WAIT_1

        if verbose:
            print("ã€ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ã€‘å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨")
            print(f"  å®¢æˆ·ç«¯çŠ¶æ€: ESTABLISHED â†’ {self.client_state.value}")
            print(f"  å‘é€: FIN=1, seq={self.client_seq}")
            print(f"  å«ä¹‰: å®¢æˆ·ç«¯è¯·æ±‚å…³é—­è¿æ¥ï¼Œä¸å†å‘é€æ•°æ®")
            print()

    def _second_wave(self, verbose: bool):
        """ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (ACK)"""
        self.server_state = TCPState.CLOSE_WAIT
        self.client_state = TCPState.FIN_WAIT_2

        if verbose:
            print("ã€ç¬¬äºŒæ¬¡æŒ¥æ‰‹ã€‘æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯")
            print(f"  æœåŠ¡å™¨çŠ¶æ€: ESTABLISHED â†’ {self.server_state.value}")
            print(f"  å®¢æˆ·ç«¯çŠ¶æ€: FIN_WAIT_1 â†’ {self.client_state.value}")
            print(f"  å‘é€: ACK=1, ack={self.client_seq + 1}")
            print(f"  å«ä¹‰: æœåŠ¡å™¨ç¡®è®¤æ”¶åˆ°å…³é—­è¯·æ±‚")
            print(f"  âš ï¸  æ­¤æ—¶è¿æ¥å¤„äºåŠå…³é—­çŠ¶æ€")
            print(f"      - å®¢æˆ·ç«¯â†’æœåŠ¡å™¨: å·²å…³é—­")
            print(f"      - æœåŠ¡å™¨â†’å®¢æˆ·ç«¯: ä»ç„¶å¼€æ”¾")
            print()

    def _third_wave(self, verbose: bool):
        """ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (FIN)"""
        self.server_state = TCPState.LAST_ACK

        if verbose:
            print("ã€ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ã€‘æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯")
            print(f"  æœåŠ¡å™¨çŠ¶æ€: CLOSE_WAIT â†’ {self.server_state.value}")
            print(f"  å‘é€: FIN=1, ACK=1, seq={self.server_seq}, ack={self.client_seq + 1}")
            print(f"  å«ä¹‰: æœåŠ¡å™¨æ•°æ®å‘é€å®Œæˆï¼Œè¯·æ±‚å…³é—­è¿æ¥")
            print()

    def _fourth_wave(self, verbose: bool):
        """ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ (ACK)"""
        self.client_state = TCPState.TIME_WAIT
        self.server_state = TCPState.CLOSED

        if verbose:
            print("ã€ç¬¬å››æ¬¡æŒ¥æ‰‹ã€‘å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨")
            print(f"  å®¢æˆ·ç«¯çŠ¶æ€: FIN_WAIT_2 â†’ {self.client_state.value}")
            print(f"  æœåŠ¡å™¨çŠ¶æ€: LAST_ACK â†’ {self.server_state.value}")
            print(f"  å‘é€: ACK=1, ack={self.server_seq + 1}")
            print(f"  å«ä¹‰: å®¢æˆ·ç«¯ç¡®è®¤æœåŠ¡å™¨çš„å…³é—­è¯·æ±‚")
            print(f"  ğŸ“Œ æœåŠ¡å™¨æ”¶åˆ°ACKåç«‹å³å…³é—­")
            print(f"  ğŸ“Œ å®¢æˆ·ç«¯è¿›å…¥TIME_WAITçŠ¶æ€")
            print()

    def _time_wait(self, verbose: bool):
        """TIME_WAITçŠ¶æ€"""
        if verbose:
            print("ã€TIME_WAITçŠ¶æ€ã€‘")
            print(f"  å®¢æˆ·ç«¯çŠ¶æ€: {self.client_state.value}")
            print(f"  æŒç»­æ—¶é—´: 2MSLï¼ˆçº¦4åˆ†é’Ÿï¼‰")
            print(f"  ä½œç”¨1: ç¡®ä¿æœ€åçš„ACKèƒ½å¤Ÿåˆ°è¾¾æœåŠ¡å™¨")
            print(f"  ä½œç”¨2: ç­‰å¾…ç½‘ç»œä¸­çš„æ—§æ•°æ®åŒ…æ¶ˆå¤±")
            print()
            print("  [ç­‰å¾…2MSL...]")
            time.sleep(0.2)

            self.client_state = TCPState.CLOSED
            print(f"  å®¢æˆ·ç«¯çŠ¶æ€: TIME_WAIT â†’ {self.client_state.value}")


class TCPStateMonitor:
    """TCPçŠ¶æ€ç›‘æ§å™¨"""

    def __init__(self):
        self.system = platform.system()

    def get_tcp_connections(self) -> List[TCPConnection]:
        """
        è·å–å½“å‰ç³»ç»Ÿçš„TCPè¿æ¥åˆ—è¡¨

        è¿”å›å€¼ï¼š
            TCPè¿æ¥åˆ—è¡¨

        å·¥ä½œåŸç†ï¼š
            ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤ï¼ˆnetstat/ssï¼‰è·å–TCPè¿æ¥ä¿¡æ¯
        """
        connections = []

        try:
            if self.system == "Linux":
                cmd = ["ss", "-ant"]
            else:
                cmd = ["netstat", "-ant"]

            result = subprocess.run(cmd, capture_output=True, text=True)
            lines = result.stdout.split('\n')

            # è·³è¿‡å¤´éƒ¨
            for line in lines[1:]:
                if not line.strip():
                    continue

                parts = line.split()
                if len(parts) < 6:
                    continue

                # è§£æçŠ¶æ€
                state_str = parts[5] if self.system != "Linux" else parts[0]
                try:
                    state = TCPState(state_str)
                except ValueError:
                    continue

                # è§£æåœ°å€ï¼ˆç®€åŒ–å¤„ç†ï¼‰
                local = parts[3] if self.system != "Linux" else parts[3]
                remote = parts[4] if self.system != "Linux" else parts[4]

                connections.append(TCPConnection(
                    local_addr="",
                    local_port=0,
                    remote_addr="",
                    remote_port=0,
                    state=state
                ))

        except Exception as e:
            print(f"è·å–è¿æ¥ä¿¡æ¯å¤±è´¥: {e}")

        return connections

    def get_state_statistics(self) -> Dict[TCPState, int]:
        """
        ç»Ÿè®¡å„çŠ¶æ€çš„è¿æ¥æ•°

        è¿”å›å€¼ï¼š
            {çŠ¶æ€: æ•°é‡} çš„å­—å…¸
        """
        stats = {state: 0 for state in TCPState}

        try:
            if self.system == "Linux":
                cmd = ["ss", "-ant"]
            else:
                cmd = ["netstat", "-ant"]

            result = subprocess.run(cmd, capture_output=True, text=True)
            lines = result.stdout.split('\n')

            for line in lines:
                for state in TCPState:
                    if state.value in line:
                        stats[state] += 1
                        break

        except Exception:
            pass

        return stats

    def display_statistics(self, verbose: bool = True):
        """
        æ˜¾ç¤ºTCPè¿æ¥ç»Ÿè®¡ä¿¡æ¯

        å‚æ•°è¯´æ˜ï¼š
            verbose: æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        """
        if verbose:
            print("=" * 70)
            print("TCPè¿æ¥çŠ¶æ€ç»Ÿè®¡")
            print("=" * 70)
            print()

        stats = self.get_state_statistics()

        if verbose:
            print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
            print("â”‚ çŠ¶æ€       â”‚ æ•°é‡ â”‚ è¯´æ˜                        â”‚")
            print("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")

        total = 0
        for state, count in stats.items():
            if count > 0:
                total += count
                desc = self._get_state_description(state)
                if verbose:
                    print(f"â”‚ {state.value:10s} â”‚ {count:4d} â”‚ {desc:27s} â”‚")

        if verbose:
            print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
            print(f"\næ€»è¿æ¥æ•°: {total}")
            print()

        # æ£€æµ‹å¼‚å¸¸
        self._check_anomalies(stats, verbose)

        return stats

    def _get_state_description(self, state: TCPState) -> str:
        """è·å–çŠ¶æ€æè¿°"""
        descriptions = {
            TCPState.LISTEN: "ç›‘å¬ä¸­",
            TCPState.ESTABLISHED: "å·²å»ºç«‹",
            TCPState.TIME_WAIT: "ç­‰å¾…2MSL",
            TCPState.CLOSE_WAIT: "ç­‰å¾…å…³é—­ï¼ˆå¯èƒ½æ³„éœ²ï¼‰",
            TCPState.FIN_WAIT_1: "ä¸»åŠ¨å…³é—­1",
            TCPState.FIN_WAIT_2: "ä¸»åŠ¨å…³é—­2",
        }
        return descriptions.get(state, "")

    def _check_anomalies(self, stats: Dict[TCPState, int], verbose: bool):
        """æ£€æµ‹å¼‚å¸¸è¿æ¥çŠ¶æ€"""
        issues = []

        # æ£€æµ‹CLOSE_WAITå †ç§¯
        if stats[TCPState.CLOSE_WAIT] > 100:
            issues.append(f"âš ï¸  CLOSE_WAITè¿æ¥è¿‡å¤šï¼ˆ{stats[TCPState.CLOSE_WAIT]}ï¼‰ï¼Œå¯èƒ½å­˜åœ¨è¿æ¥æ³„éœ²")

        # æ£€æµ‹TIME_WAITå †ç§¯
        if stats[TCPState.TIME_WAIT] > 1000:
            issues.append(f"âš ï¸  TIME_WAITè¿æ¥è¿‡å¤šï¼ˆ{stats[TCPState.TIME_WAIT]}ï¼‰ï¼Œè€ƒè™‘ä¼˜åŒ–çŸ­è¿æ¥")

        if issues and verbose:
            print("ã€å¼‚å¸¸æ£€æµ‹ã€‘")
            for issue in issues:
                print(f"  {issue}")
            print()


class LifecycleVisualizer:
    """ç”Ÿå‘½å‘¨æœŸå¯è§†åŒ–å·¥å…·"""

    @staticmethod
    def draw_lifecycle():
        """ç»˜åˆ¶TCPè¿æ¥å®Œæ•´ç”Ÿå‘½å‘¨æœŸ"""
        print("""
TCPè¿æ¥å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å»ºç«‹è¿æ¥ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¢æˆ·ç«¯                                      æœåŠ¡å™¨          â”‚
â”‚   CLOSED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> LISTEN          â”‚
â”‚     â”‚ SYN                                       â”‚             â”‚
â”‚     â–¼                                           â–¼             â”‚
â”‚  SYN_SENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SYN-ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> SYN_RCVD          â”‚
â”‚     â”‚                                           â”‚             â”‚
â”‚     â”‚ ACK                                       â”‚             â”‚
â”‚     â–¼                                           â–¼             â”‚
â”‚  ESTABLISHED <â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•> ESTABLISHED          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æ•°æ®ä¼ è¾“é˜¶æ®µ                          â”‚
â”‚  ESTABLISHED <â•â•â•â•â•â•â• æ•°æ®äº¤æ¢ â•â•â•â•â•â•> ESTABLISHED          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        å…³é—­è¿æ¥ï¼ˆå››æ¬¡æŒ¥æ‰‹ï¼‰                  â”‚
â”‚  ä¸»åŠ¨å…³é—­æ–¹                                 è¢«åŠ¨å…³é—­æ–¹        â”‚
â”‚  ESTABLISHED                             ESTABLISHED          â”‚
â”‚     â”‚ FIN                                       â”‚             â”‚
â”‚     â–¼                                           â–¼             â”‚
â”‚  FIN_WAIT_1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> CLOSE_WAIT          â”‚
â”‚     â”‚                                           â”‚             â”‚
â”‚     â–¼                                           â”‚ åº”ç”¨å±‚å…³é—­  â”‚
â”‚  FIN_WAIT_2                                     â”‚             â”‚
â”‚     â”‚                                           â–¼             â”‚
â”‚     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LAST_ACK           â”‚
â”‚     â–¼                                           â”‚             â”‚
â”‚  TIME_WAIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>     â”‚             â”‚
â”‚     â”‚                                           â–¼             â”‚
â”‚     â”‚ ç­‰å¾…2MSL                               CLOSED           â”‚
â”‚     â–¼                                                         â”‚
â”‚  CLOSED                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        """)


def main():
    """
    ä¸»å‡½æ•°ï¼šæ¼”ç¤ºTCPè¿æ¥ç”Ÿå‘½å‘¨æœŸ
    """
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         TCPå››æ¬¡æŒ¥æ‰‹å’ŒçŠ¶æ€æœº - Day 42 å®æˆ˜é¡¹ç›®               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

    # 1. æ˜¾ç¤ºå®Œæ•´ç”Ÿå‘½å‘¨æœŸ
    print("\nã€1. TCPè¿æ¥å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‘")
    LifecycleVisualizer.draw_lifecycle()

    # 2. æ¨¡æ‹Ÿå››æ¬¡æŒ¥æ‰‹
    print("\nã€2. å››æ¬¡æŒ¥æ‰‹æ¨¡æ‹Ÿã€‘")
    simulator = WavehandSimulator()
    simulator.simulate_close()

    # 3. æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„TCPè¿æ¥çŠ¶æ€
    print("\nã€3. ç³»ç»ŸTCPè¿æ¥çŠ¶æ€ã€‘")
    monitor = TCPStateMonitor()
    monitor.display_statistics()

    # 4. å®é™…æ¼”ç¤º
    print("\nã€4. å®é™…è¿æ¥æ¼”ç¤ºã€‘")
    print("åˆ›å»ºçœŸå®TCPè¿æ¥å¹¶è§‚å¯ŸçŠ¶æ€å˜åŒ–...\n")

    try:
        # åˆ›å»ºè¿æ¥
        print("ğŸ”— å»ºç«‹è¿æ¥åˆ° www.baidu.com:80")
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        sock.connect(('www.baidu.com', 80))
        print(f"âœ… è¿æ¥çŠ¶æ€: {sock.getsockname()} â†â†’ {sock.getpeername()}")
        print("   å½“å‰çŠ¶æ€: ESTABLISHED")

        # å‘é€HTTPè¯·æ±‚
        print("\nğŸ“¤ å‘é€HTTPè¯·æ±‚...")
        request = b"GET / HTTP/1.1\r\nHost: www.baidu.com\r\n\r\n"
        sock.sendall(request)

        # æ¥æ”¶å“åº”
        print("ğŸ“¥ æ¥æ”¶å“åº”...")
        response = sock.recv(1024)
        print(f"   æ”¶åˆ° {len(response)} å­—èŠ‚")

        # å…³é—­è¿æ¥
        print("\nğŸ”š å…³é—­è¿æ¥...")
        sock.close()
        print("   å¼€å§‹å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹")
        print("   ï¼ˆå®¢æˆ·ç«¯ä¼šè¿›å…¥TIME_WAITçŠ¶æ€ï¼‰")

    except Exception as e:
        print(f"âŒ æ¼”ç¤ºå¤±è´¥: {e}")

    print("""
\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ å…³é”®è¦ç‚¹ï¼š

1. å››æ¬¡æŒ¥æ‰‹ç¡®ä¿åŒæ–¹éƒ½å®Œæˆæ•°æ®ä¼ è¾“
2. TIME_WAITçŠ¶æ€æŒç»­2MSLï¼ˆçº¦4åˆ†é’Ÿï¼‰
3. CLOSE_WAITå †ç§¯é€šå¸¸è¡¨ç¤ºåº”ç”¨ç¨‹åºæœªæ­£ç¡®å…³é—­è¿æ¥
4. åŠå…³é—­çŠ¶æ€å…è®¸å•å‘æ•°æ®ä¼ è¾“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")


if __name__ == "__main__":
    main()
