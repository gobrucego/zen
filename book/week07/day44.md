# Day 44: TCPæ‹¥å¡æ§åˆ¶ç®—æ³•

## ğŸ“š ä»Šæ—¥å¯¼è¯­

æ˜¨å¤©æˆ‘ä»¬å­¦ä¹ äº†TCPæµé‡æ§åˆ¶ï¼ˆé˜²æ­¢æ¥æ”¶æ–¹è¿‡è½½ï¼‰ï¼Œä»Šå¤©æˆ‘ä»¬è¦å­¦ä¹ TCPæ‹¥å¡æ§åˆ¶ï¼ˆé˜²æ­¢ç½‘ç»œæ‹¥å¡ï¼‰ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
ğŸš— **æµé‡æ§åˆ¶** = çœ‹ç€ä¹˜å®¢çš„çŠ¶æ€å†³å®šå¼€å¤šå¿«ï¼ˆé˜²æ­¢ä¹˜å®¢æ™•è½¦ï¼‰
ğŸš¦ **æ‹¥å¡æ§åˆ¶** = çœ‹ç€é“è·¯çŠ¶å†µå†³å®šå¼€å¤šå¿«ï¼ˆé˜²æ­¢å µè½¦ï¼‰

ä¸¤è€…ç›®çš„ä¸åŒï¼š
- æµé‡æ§åˆ¶ï¼šä¿æŠ¤æ¥æ”¶æ–¹
- æ‹¥å¡æ§åˆ¶ï¼šä¿æŠ¤æ•´ä¸ªç½‘ç»œ

---

## ğŸ¯ ä»Šæ—¥ç›®æ ‡

å­¦å®Œæœ¬ç« èŠ‚ï¼Œä½ å°†èƒ½å¤Ÿï¼š

- âœ… ç†è§£ç½‘ç»œæ‹¥å¡çš„åŸå› å’Œåæœ
- âœ… æŒæ¡æ…¢å¯åŠ¨ç®—æ³•
- âœ… ç†è§£æ‹¥å¡é¿å…ç®—æ³•
- âœ… æŒæ¡å¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿæ¢å¤
- âœ… äº†è§£ç°ä»£æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼ˆBBRã€CUBICï¼‰

---

## ğŸ“– ç†è®ºè®²è§£

### 1. ä»€ä¹ˆæ˜¯ç½‘ç»œæ‹¥å¡ï¼Ÿ

**æ‹¥å¡çš„å®šä¹‰**ï¼š
```
ç½‘ç»œä¸­çš„æ•°æ®æµé‡è¶…è¿‡ç½‘ç»œæ‰¿è½½èƒ½åŠ›
â†’ è·¯ç”±å™¨ç¼“å†²åŒºæº¢å‡º
â†’ æ•°æ®åŒ…ä¸¢å¤±
â†’ å»¶è¿Ÿå¢åŠ 
â†’ é‡ä¼ å¢åŠ 
â†’ æ›´åŠ æ‹¥å¡ï¼ˆæ¶æ€§å¾ªç¯ï¼‰
```

**æ‹¥å¡çš„åæœ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ç½‘ç»œååé‡ vs è´Ÿè½½å…³ç³»           â”‚
â”‚                                         â”‚
â”‚  ååé‡                                 â”‚
â”‚    â†‘                                    â”‚
â”‚    â”‚        ç†æƒ³æƒ…å†µ                    â”‚
â”‚    â”‚       â•±â•±â•±â•±â•±â•±â•±â•±â•±                   â”‚
â”‚    â”‚      â•±                             â”‚
â”‚    â”‚     â•±  å®é™…æƒ…å†µ                    â”‚
â”‚    â”‚    â•±   â•±â€¾â€¾â€¾â€¾â€¾â•²                    â”‚
â”‚    â”‚   â•±   â•±       â•² â† æ‹¥å¡å´©æºƒ        â”‚
â”‚    â”‚  â•±   â•±         â•²                   â”‚
â”‚    â”‚ â•±___â•±___________â•²___               â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è´Ÿè½½         â”‚
â”‚         â†‘æ‹¥å¡ç‚¹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç‚¹ï¼š
- è´Ÿè½½å¢åŠ ï¼Œååé‡å…ˆå¢åŠ 
- è¶…è¿‡æŸä¸ªç‚¹åï¼Œååé‡åè€Œä¸‹é™
- è¿™å°±æ˜¯"æ‹¥å¡å´©æºƒ"
```

---

### 2. æ‹¥å¡æ§åˆ¶ vs æµé‡æ§åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯¹æ¯”é¡¹       â”‚ æµé‡æ§åˆ¶      â”‚ æ‹¥å¡æ§åˆ¶       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç›®çš„         â”‚ é˜²æ­¢æ¥æ”¶æ–¹è¿‡è½½â”‚ é˜²æ­¢ç½‘ç»œæ‹¥å¡   â”‚
â”‚ æ§åˆ¶è€…       â”‚ æ¥æ”¶æ–¹        â”‚ å‘é€æ–¹         â”‚
â”‚ æœºåˆ¶         â”‚ æ»‘åŠ¨çª—å£      â”‚ æ‹¥å¡çª—å£       â”‚
â”‚ çª—å£å­—æ®µ     â”‚ rwnd (é€šå‘Š)   â”‚ cwnd (æœ¬åœ°)    â”‚
â”‚ ä¾æ®         â”‚ æ¥æ”¶ç¼“å†²åŒº    â”‚ ç½‘ç»œçŠ¶å†µ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…å‘é€çª—å£ = min(cwnd, rwnd)
             = min(æ‹¥å¡çª—å£, æ¥æ”¶çª—å£)
```

---

### 3. æ…¢å¯åŠ¨ï¼ˆSlow Startï¼‰

#### ç®—æ³•æ€æƒ³

**é—®é¢˜**ï¼šä¸€å¼€å§‹å°±å‘é€å¤§é‡æ•°æ®å¯èƒ½å¯¼è‡´ç½‘ç»œæ‹¥å¡

**è§£å†³**ï¼šä»å°çª—å£å¼€å§‹ï¼ŒæŒ‡æ•°å¢é•¿æ¢æµ‹ç½‘ç»œå®¹é‡

```
æ…¢å¯åŠ¨è¿‡ç¨‹ï¼š
cwndåˆå§‹ = 1 MSSï¼ˆMaximum Segment Sizeï¼Œæœ€å¤§æ®µå¤§å°ï¼‰

æ¯æ”¶åˆ°ä¸€ä¸ªACKï¼š
  cwnd = cwnd + 1 MSS

æ•ˆæœï¼š
ç¬¬1ä¸ªRTTï¼šå‘é€ 1ä¸ª MSSï¼Œæ”¶åˆ°1ä¸ªACK â†’ cwnd = 2
ç¬¬2ä¸ªRTTï¼šå‘é€ 2ä¸ª MSSï¼Œæ”¶åˆ°2ä¸ªACK â†’ cwnd = 4
ç¬¬3ä¸ªRTTï¼šå‘é€ 4ä¸ª MSSï¼Œæ”¶åˆ°4ä¸ªACK â†’ cwnd = 8
ç¬¬4ä¸ªRTTï¼šå‘é€ 8ä¸ª MSSï¼Œæ”¶åˆ°8ä¸ªACK â†’ cwnd = 16

æŒ‡æ•°å¢é•¿ï¼š1 â†’ 2 â†’ 4 â†’ 8 â†’ 16 â†’ 32 â†’ ...
```

**å¯è§†åŒ–**ï¼š

```
æ‹¥å¡çª—å£ï¼ˆMSSï¼‰
   â†‘
32 â”‚                        â—
16 â”‚              â—
 8 â”‚        â—
 4 â”‚    â—
 2 â”‚  â—
 1 â”‚â—
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ RTT
    1  2  3  4  5  6  7

æ¯ä¸ªRTTçª—å£ç¿»å€ï¼ˆæŒ‡æ•°å¢é•¿ï¼‰
```

#### æ…¢å¯åŠ¨é˜ˆå€¼ï¼ˆssthreshï¼‰

**é—®é¢˜**ï¼šä¸èƒ½ä¸€ç›´æŒ‡æ•°å¢é•¿ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ‹¥å¡

**è§£å†³**ï¼šè®¾ç½®æ…¢å¯åŠ¨é˜ˆå€¼ï¼ˆSlow Start Thresholdï¼‰

```
ç®—æ³•ï¼š
if cwnd < ssthresh:
    æ…¢å¯åŠ¨ï¼ˆæŒ‡æ•°å¢é•¿ï¼‰
else:
    æ‹¥å¡é¿å…ï¼ˆçº¿æ€§å¢é•¿ï¼‰

åˆå§‹å€¼ï¼š
ssthresh = 65535å­—èŠ‚ï¼ˆæˆ–æ— ç©·å¤§ï¼‰

å‘ç”Ÿæ‹¥å¡æ—¶ï¼š
ssthresh = max(cwnd / 2, 2 * MSS)
cwnd = 1 MSS
é‡æ–°å¼€å§‹æ…¢å¯åŠ¨
```

---

### 4. æ‹¥å¡é¿å…ï¼ˆCongestion Avoidanceï¼‰

#### ç®—æ³•æ€æƒ³

**ç›®çš„**ï¼šæ¥è¿‘ç½‘ç»œå®¹é‡æ—¶ï¼Œè°¨æ…å¢é•¿ï¼Œé¿å…æ‹¥å¡

**æ–¹æ³•**ï¼šçº¿æ€§å¢é•¿è€ŒéæŒ‡æ•°å¢é•¿

```
æ‹¥å¡é¿å…ç®—æ³•ï¼ˆæ¯ä¸ªRTTï¼‰ï¼š
cwnd = cwnd + MSS * MSS / cwnd
â‰ˆ cwnd + MSS / (cwnd / MSS)
â‰ˆ cwnd + 1 / æ¯ä¸ªçª—å£ä¸­çš„æ®µæ•°

ç®€åŒ–ï¼š
æ¯ä¸ªRTTï¼Œçª—å£å¢åŠ 1ä¸ªMSS
```

**ç¤ºä¾‹**ï¼š

```
å‡è®¾ MSS = 1000å­—èŠ‚

æ…¢å¯åŠ¨é˜¶æ®µï¼ˆcwnd < ssthresh = 8000ï¼‰ï¼š
RTT 1: cwnd = 1000 â†’ 2000ï¼ˆç¿»å€ï¼‰
RTT 2: cwnd = 2000 â†’ 4000ï¼ˆç¿»å€ï¼‰
RTT 3: cwnd = 4000 â†’ 8000ï¼ˆç¿»å€ï¼‰

æ‹¥å¡é¿å…é˜¶æ®µï¼ˆcwnd >= ssthreshï¼‰ï¼š
RTT 4: cwnd = 8000 â†’ 9000ï¼ˆ+1 MSSï¼‰
RTT 5: cwnd = 9000 â†’ 10000ï¼ˆ+1 MSSï¼‰
RTT 6: cwnd = 10000 â†’ 11000ï¼ˆ+1 MSSï¼‰
```

**å¯è§†åŒ–**ï¼š

```
æ‹¥å¡çª—å£
   â†‘
   â”‚                      æ…¢å¯åŠ¨     æ‹¥å¡é¿å…
   â”‚                      (æŒ‡æ•°)     (çº¿æ€§)
16 â”‚                        â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—
   â”‚                       /
 8 â”‚              â—       / ssthresh
   â”‚        â—            /
 4 â”‚    â—               /
 2 â”‚  â—                /
 1 â”‚â—                 /
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
```

---

### 5. å¿«é€Ÿé‡ä¼ ï¼ˆFast Retransmitï¼‰

#### é—®é¢˜èƒŒæ™¯

**ä¼ ç»Ÿé‡ä¼ **ï¼š
```
å‘é€æ–¹å‘é€ï¼š1, 2, 3, 4, 5
æ•°æ®åŒ…3ä¸¢å¤±
æ¥æ”¶æ–¹æ”¶åˆ°ï¼š1, 2, 4, 5
æ¥æ”¶æ–¹å‘é€ï¼šACK=3, ACK=3, ACK=3ï¼ˆé‡å¤ACKï¼‰

ä¼ ç»Ÿåšæ³•ï¼š
ç­‰å¾…è¶…æ—¶ï¼ˆé€šå¸¸å‡ ç§’ï¼‰ â†’ é‡ä¼ 

é—®é¢˜ï¼šç­‰å¾…æ—¶é—´å¤ªé•¿
```

#### å¿«é€Ÿé‡ä¼ ç®—æ³•

**æ ¸å¿ƒæ€æƒ³**ï¼šæ”¶åˆ°3ä¸ªé‡å¤ACKï¼Œç«‹å³é‡ä¼ ï¼Œä¸ç­‰è¶…æ—¶

```
ç®—æ³•ï¼š
æ”¶åˆ°3ä¸ªé‡å¤ACKï¼ˆç´¯è®¡4ä¸ªç›¸åŒACKï¼‰:
  é‡ä¼ ä¸¢å¤±çš„æ•°æ®åŒ…
  ä¸ç­‰å¾…è¶…æ—¶è®¡æ—¶å™¨
```

**ç¤ºä¾‹**ï¼š

```
æ—¶é—´çº¿ï¼š
t=0:   å‘é€ seq=1000
t=1:   å‘é€ seq=2000
t=2:   å‘é€ seq=3000  â† ä¸¢å¤±
t=3:   å‘é€ seq=4000
t=4:   å‘é€ seq=5000

æ¥æ”¶æ–¹ï¼š
æ”¶åˆ°1000 â†’ å‘é€ACK=2000
æ”¶åˆ°2000 â†’ å‘é€ACK=3000
æ”¶åˆ°4000 â†’ æœŸæœ›3000ï¼Œå‘é€ACK=3000ï¼ˆç¬¬1ä¸ªé‡å¤ï¼‰
æ”¶åˆ°5000 â†’ æœŸæœ›3000ï¼Œå‘é€ACK=3000ï¼ˆç¬¬2ä¸ªé‡å¤ï¼‰

å‘é€æ–¹ï¼š
æ”¶åˆ°4ä¸ªACK=3000 â†’ ç«‹å³é‡ä¼ seq=3000
ï¼ˆä¸ç­‰è¶…æ—¶ï¼ï¼‰
```

---

### 6. å¿«é€Ÿæ¢å¤ï¼ˆFast Recoveryï¼‰

#### ç®—æ³•æ€æƒ³

**é—®é¢˜**ï¼šå¿«é€Ÿé‡ä¼ åï¼Œæ˜¯å¦éœ€è¦å›åˆ°æ…¢å¯åŠ¨ï¼Ÿ

**ä¼ ç»Ÿåšæ³•**ï¼š
```
å‘ç”Ÿä¸¢åŒ… â†’ cwnd = 1 MSS
        â†’ ssthresh = cwnd / 2
        â†’ é‡æ–°æ…¢å¯åŠ¨
```

**å¿«é€Ÿæ¢å¤åšæ³•**ï¼š
```
å‘ç”Ÿä¸¢åŒ…ï¼ˆæ”¶åˆ°é‡å¤ACKï¼‰ï¼š
1. ssthresh = cwnd / 2
2. cwnd = ssthresh + 3 * MSS
3. é‡ä¼ ä¸¢å¤±çš„æ®µ
4. æ¯æ”¶åˆ°ä¸€ä¸ªé‡å¤ACKï¼Œcwnd += 1 MSS
5. æ”¶åˆ°æ–°ACKï¼Œcwnd = ssthreshï¼ˆè¿›å…¥æ‹¥å¡é¿å…ï¼‰
```

**ä¸ºä»€ä¹ˆ+3 MSSï¼Ÿ**
```
æ”¶åˆ°3ä¸ªé‡å¤ACKæ„å‘³ç€ï¼š
- è¿™3ä¸ªæ®µå·²ç»ç¦»å¼€ç½‘ç»œï¼ˆè¢«æ¥æ”¶ï¼‰
- ç½‘ç»œä¸­æœ‰ç©ºé—´å¯ä»¥å‘é€æ–°æ•°æ®
- ä¸´æ—¶å¢åŠ çª—å£
```

---

### 7. å®Œæ•´çš„æ‹¥å¡æ§åˆ¶çŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ…¢å¯åŠ¨      â”‚
â”‚ cwnd<ssthreshâ”‚
â”‚ æŒ‡æ•°å¢é•¿    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ cwnd >= ssthresh
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‹¥å¡é¿å…    â”‚
â”‚ cwndâ‰¥ssthreshâ”‚
â”‚ çº¿æ€§å¢é•¿    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€ è¶…æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚
       â”‚                       â–¼
       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚ ssthresh=cwnd/2â”‚
       â”‚              â”‚ cwnd = 1       â”‚
       â”‚              â”‚ å›åˆ°æ…¢å¯åŠ¨     â”‚
       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€ æ”¶åˆ°3ä¸ªé‡å¤ACK â”€â”€â”€â”
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¿«é€Ÿé‡ä¼      â”‚    â”‚ ssthresh=cwnd/2 â”‚
â”‚              â”‚â”€â”€â”€>â”‚ cwnd=ssthresh+3 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ å¿«é€Ÿæ¢å¤        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ æ”¶åˆ°æ–°ACK
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ cwnd = ssthresh â”‚
                    â”‚ æ‹¥å¡é¿å…        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8. ç°ä»£æ‹¥å¡æ§åˆ¶ç®—æ³•

#### TCP Renoï¼ˆç»å…¸ç®—æ³•ï¼‰

```
ç‰¹ç‚¹ï¼š
- æ…¢å¯åŠ¨ + æ‹¥å¡é¿å…
- å¿«é€Ÿé‡ä¼  + å¿«é€Ÿæ¢å¤
- åŸºäºä¸¢åŒ…æ£€æµ‹æ‹¥å¡

é—®é¢˜ï¼š
- é«˜é€Ÿç½‘ç»œæ•ˆç‡ä½
- å¯¹ä¸¢åŒ…æ•æ„Ÿ
```

#### TCP Cubicï¼ˆLinuxé»˜è®¤ï¼‰

```
ç‰¹ç‚¹ï¼š
- ä¸‰æ¬¡å‡½æ•°å¢é•¿ï¼ˆç«‹æ–¹å‡½æ•°ï¼‰
- ä¸å®Œå…¨ä¾èµ–RTT
- æ›´é€‚åˆé«˜é€Ÿé•¿è·ç¦»ç½‘ç»œ

çª—å£å¢é•¿ï¼š
W(t) = C(t - K)Â³ + W_max

å…¶ä¸­ï¼š
- Cï¼šå¸¸æ•°
- tï¼šæ—¶é—´
- Kï¼šä¸Šæ¬¡æ‹¥å¡åˆ°ç°åœ¨çš„æ—¶é—´
- W_maxï¼šä¸Šæ¬¡æ‹¥å¡æ—¶çš„çª—å£å¤§å°
```

**CUBICå¢é•¿æ›²çº¿**ï¼š

```
çª—å£å¤§å°
   â†‘
   â”‚        ç«‹æ–¹å¢é•¿
   â”‚         â•±â•²
   â”‚        â•±  â•²
   â”‚       â•±    â•²
   â”‚      â•±      â•²
   â”‚     â•±        â•²
W_maxâ”œâ”€â”€â”€â”€â—        â—â”€â”€â”€â”€
   â”‚           â†‘
   â”‚           K(æ‹ç‚¹)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
```

#### BBRï¼ˆGoogleå¼€å‘ï¼‰

```
ç‰¹ç‚¹ï¼š
- ä¸åŸºäºä¸¢åŒ…
- åŸºäºå¸¦å®½å’ŒRTT
- ä¸»åŠ¨æ¢æµ‹ç½‘ç»œçŠ¶å†µ

æ ¸å¿ƒæ€æƒ³ï¼š
BtlBwï¼ˆç“¶é¢ˆå¸¦å®½ï¼‰
RTpropï¼ˆå¾€è¿”ä¼ æ’­å»¶è¿Ÿï¼‰

å‘é€é€Ÿç‡ = BtlBw
åœ¨é€”æ•°æ® = BtlBw Ã— RTprop

çŠ¶æ€æœºï¼š
STARTUP â†’ DRAIN â†’ PROBE_BW â†’ PROBE_RTT
```

---

## ğŸ’» å®æˆ˜é¡¹ç›®ï¼šTCPæ‹¥å¡æ§åˆ¶æ¨¡æ‹Ÿå™¨

ä»Šå¤©æˆ‘ä»¬å®ç°ä¸€ä¸ªæ‹¥å¡æ§åˆ¶ç®—æ³•çš„æ¨¡æ‹Ÿå™¨ã€‚

### ä»£ç å®ç°

```python
# day44_congestion_control_simulator.py
# åŠŸèƒ½ï¼šTCPæ‹¥å¡æ§åˆ¶ç®—æ³•æ¨¡æ‹Ÿå™¨

import time
from enum import Enum
from typing import List
import matplotlib
matplotlib.use('Agg')  # ä½¿ç”¨éGUIåç«¯
import matplotlib.pyplot as plt


class CongestionState(Enum):
    """æ‹¥å¡æ§åˆ¶çŠ¶æ€"""
    SLOW_START = "æ…¢å¯åŠ¨"
    CONGESTION_AVOIDANCE = "æ‹¥å¡é¿å…"
    FAST_RECOVERY = "å¿«é€Ÿæ¢å¤"


class TCPCongestionControl:
    """TCPæ‹¥å¡æ§åˆ¶æ¨¡æ‹Ÿå™¨"""

    def __init__(self, mss: int = 1000, initial_ssthresh: int = 16000):
        """
        åˆå§‹åŒ–æ‹¥å¡æ§åˆ¶

        å‚æ•°è¯´æ˜ï¼š
            mss: æœ€å¤§æ®µå¤§å°ï¼ˆMaximum Segment Sizeï¼‰
            initial_ssthresh: åˆå§‹æ…¢å¯åŠ¨é˜ˆå€¼
        """
        self.mss = mss
        self.cwnd = mss  # æ‹¥å¡çª—å£ï¼Œåˆå§‹ä¸º1 MSS
        self.ssthresh = initial_ssthresh  # æ…¢å¯åŠ¨é˜ˆå€¼
        self.state = CongestionState.SLOW_START
        self.history = []  # è®°å½•å†å²
        self.rtt = 0  # RTTè®¡æ•°

    def on_ack_received(self):
        """
        æ”¶åˆ°ACKæ—¶çš„å¤„ç†

        å·¥ä½œåŸç†ï¼š
            æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°æ‹¥å¡çª—å£
        """
        if self.state == CongestionState.SLOW_START:
            # æ…¢å¯åŠ¨ï¼šæ¯ä¸ªACKï¼Œcwndå¢åŠ 1 MSSï¼ˆæŒ‡æ•°å¢é•¿ï¼‰
            self.cwnd += self.mss

            # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
            if self.cwnd >= self.ssthresh:
                self.state = CongestionState.CONGESTION_AVOIDANCE
                print(f"  è¾¾åˆ°ssthresh={self.ssthresh}ï¼Œè¿›å…¥æ‹¥å¡é¿å…")

        elif self.state == CongestionState.CONGESTION_AVOIDANCE:
            # æ‹¥å¡é¿å…ï¼šæ¯ä¸ªRTTï¼Œcwndå¢åŠ 1 MSSï¼ˆçº¿æ€§å¢é•¿ï¼‰
            # è¿‘ä¼¼ï¼šæ¯ä¸ªACKå¢åŠ  MSS/cwnd
            increment = self.mss * self.mss // self.cwnd
            self.cwnd += increment

        elif self.state == CongestionState.FAST_RECOVERY:
            # å¿«é€Ÿæ¢å¤ï¼šæ¯ä¸ªé‡å¤ACKï¼Œcwndå¢åŠ 1 MSS
            self.cwnd += self.mss

    def on_timeout(self):
        """
        è¶…æ—¶äº‹ä»¶å¤„ç†

        å·¥ä½œåŸç†ï¼š
            å‘ç”Ÿè¶…æ—¶è¡¨ç¤ºä¸¥é‡æ‹¥å¡ï¼Œé‡æ–°æ…¢å¯åŠ¨
        """
        print(f"\nâŒ è¶…æ—¶ï¼cwnd={self.cwnd} â†’ ssthresh={self.cwnd//2}, cwnd={self.mss}")
        self.ssthresh = max(self.cwnd // 2, 2 * self.mss)
        self.cwnd = self.mss
        self.state = CongestionState.SLOW_START

    def on_duplicate_ack(self, count: int):
        """
        æ”¶åˆ°é‡å¤ACK

        å‚æ•°è¯´æ˜ï¼š
            count: é‡å¤ACKçš„æ•°é‡

        å·¥ä½œåŸç†ï¼š
            3ä¸ªé‡å¤ACKè§¦å‘å¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿæ¢å¤
        """
        if count == 3:
            print(f"\nâš ï¸  æ”¶åˆ°3ä¸ªé‡å¤ACKï¼è§¦å‘å¿«é€Ÿé‡ä¼ ")
            print(f"  cwnd={self.cwnd} â†’ ssthresh={self.cwnd//2}, cwnd={self.cwnd//2 + 3*self.mss}")

            # å¿«é€Ÿé‡ä¼ 
            self.ssthresh = max(self.cwnd // 2, 2 * self.mss)
            self.cwnd = self.ssthresh + 3 * self.mss
            self.state = CongestionState.FAST_RECOVERY

    def on_new_ack_after_recovery(self):
        """
        å¿«é€Ÿæ¢å¤åæ”¶åˆ°æ–°ACK

        å·¥ä½œåŸç†ï¼š
            é€€å‡ºå¿«é€Ÿæ¢å¤ï¼Œè¿›å…¥æ‹¥å¡é¿å…
        """
        if self.state == CongestionState.FAST_RECOVERY:
            print(f"  æ”¶åˆ°æ–°ACKï¼Œé€€å‡ºå¿«é€Ÿæ¢å¤")
            self.cwnd = self.ssthresh
            self.state = CongestionState.CONGESTION_AVOIDANCE

    def simulate_rtt(self, num_acks: int):
        """
        æ¨¡æ‹Ÿä¸€ä¸ªRTT

        å‚æ•°è¯´æ˜ï¼š
            num_acks: è¿™ä¸ªRTTæ”¶åˆ°çš„ACKæ•°é‡
        """
        for _ in range(num_acks):
            self.on_ack_received()

        self.rtt += 1
        self.record_state()

    def record_state(self):
        """è®°å½•å½“å‰çŠ¶æ€"""
        self.history.append({
            'rtt': self.rtt,
            'cwnd': self.cwnd,
            'ssthresh': self.ssthresh,
            'state': self.state.value
        })

    def print_status(self):
        """æ‰“å°å½“å‰çŠ¶æ€"""
        segments = self.cwnd // self.mss
        print(f"RTT {self.rtt}: cwnd={self.cwnd:6d} ({segments:3d} MSS), "
              f"ssthresh={self.ssthresh:6d}, çŠ¶æ€={self.state.value}")

    def visualize(self, filename='congestion_control.png'):
        """
        å¯è§†åŒ–æ‹¥å¡æ§åˆ¶è¿‡ç¨‹

        å‚æ•°è¯´æ˜ï¼š
            filename: ä¿å­˜çš„å›¾ç‰‡æ–‡ä»¶å
        """
        if not self.history:
            return

        rtts = [h['rtt'] for h in self.history]
        cwnds = [h['cwnd'] // self.mss for h in self.history]
        ssthreshs = [h['ssthresh'] // self.mss for h in self.history]

        plt.figure(figsize=(12, 6))

        # ç»˜åˆ¶cwnd
        plt.plot(rtts, cwnds, 'b-', linewidth=2, label='cwnd')

        # ç»˜åˆ¶ssthresh
        plt.plot(rtts, ssthreshs, 'r--', linewidth=2, label='ssthresh')

        # æ ‡æ³¨çŠ¶æ€å˜åŒ–
        current_state = self.history[0]['state']
        start_idx = 0
        colors = {
            'æ…¢å¯åŠ¨': 'lightblue',
            'æ‹¥å¡é¿å…': 'lightgreen',
            'å¿«é€Ÿæ¢å¤': 'lightyellow'
        }

        for i, h in enumerate(self.history):
            if h['state'] != current_state or i == len(self.history) - 1:
                plt.axvspan(start_idx, i, alpha=0.3,
                           color=colors.get(current_state, 'lightgray'))
                plt.text((start_idx + i) / 2, max(cwnds) * 0.9,
                        current_state, ha='center')
                current_state = h['state']
                start_idx = i

        plt.xlabel('RTT', fontsize=12)
        plt.ylabel('çª—å£å¤§å° (MSS)', fontsize=12)
        plt.title('TCPæ‹¥å¡æ§åˆ¶ç®—æ³•æ¨¡æ‹Ÿ', fontsize=14)
        plt.legend()
        plt.grid(True, alpha=0.3)
        plt.savefig(filename)
        print(f"\nå›¾è¡¨å·²ä¿å­˜åˆ° {filename}")


def main():
    """
    ä¸»å‡½æ•°ï¼šæ¼”ç¤ºTCPæ‹¥å¡æ§åˆ¶
    """
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          TCPæ‹¥å¡æ§åˆ¶ç®—æ³• - Day 44 å®æˆ˜é¡¹ç›®                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

    # åˆ›å»ºæ‹¥å¡æ§åˆ¶å®ä¾‹
    cc = TCPCongestionControl(mss=1000, initial_ssthresh=16000)

    print("\nåœºæ™¯1ï¼šæ­£å¸¸æƒ…å†µï¼ˆæ…¢å¯åŠ¨ â†’ æ‹¥å¡é¿å…ï¼‰")
    print("=" * 70)

    # æ¨¡æ‹Ÿ20ä¸ªRTT
    for rtt in range(20):
        segments = cc.cwnd // cc.mss
        cc.simulate_rtt(segments)  # æ¯ä¸ªRTTæ”¶åˆ°cwnd/mssä¸ªACK
        cc.print_status()
        time.sleep(0.1)

    print("\nåœºæ™¯2ï¼šå‘ç”Ÿä¸¢åŒ…ï¼ˆå¿«é€Ÿé‡ä¼ ï¼‰")
    print("=" * 70)

    # ç»§ç»­5ä¸ªRTT
    for rtt in range(5):
        segments = cc.cwnd // cc.mss
        cc.simulate_rtt(segments)
        cc.print_status()

    # æ¨¡æ‹Ÿæ”¶åˆ°3ä¸ªé‡å¤ACK
    print(f"\nç¬¬{cc.rtt + 1}ä¸ªRTT:")
    cc.on_duplicate_ack(3)
    cc.record_state()
    cc.print_status()

    # å¿«é€Ÿæ¢å¤é˜¶æ®µ
    for _ in range(3):
        cc.on_ack_received()  # æ”¶åˆ°é‡å¤ACK

    # æ”¶åˆ°æ–°ACK
    cc.on_new_ack_after_recovery()
    cc.record_state()
    cc.print_status()

    # ç»§ç»­æ­£å¸¸ä¼ è¾“
    for rtt in range(10):
        segments = cc.cwnd // cc.mss
        cc.simulate_rtt(segments)
        cc.print_status()

    print("\nåœºæ™¯3ï¼šè¶…æ—¶ï¼ˆä¸¥é‡æ‹¥å¡ï¼‰")
    print("=" * 70)

    # ç»§ç»­å‡ ä¸ªRTT
    for rtt in range(5):
        segments = cc.cwnd // cc.mss
        cc.simulate_rtt(segments)
        cc.print_status()

    # æ¨¡æ‹Ÿè¶…æ—¶
    cc.on_timeout()
    cc.record_state()

    # é‡æ–°æ…¢å¯åŠ¨
    for rtt in range(15):
        segments = cc.cwnd // cc.mss
        cc.simulate_rtt(segments)
        cc.print_status()

    # å¯è§†åŒ–
    cc.visualize()

    print("""
\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ æ ¸å¿ƒè¦ç‚¹æ€»ç»“ï¼š

1. æ…¢å¯åŠ¨ï¼šä»å°çª—å£å¼€å§‹ï¼ŒæŒ‡æ•°å¢é•¿æ¢æµ‹ç½‘ç»œå®¹é‡
2. æ‹¥å¡é¿å…ï¼šæ¥è¿‘å®¹é‡æ—¶ï¼Œçº¿æ€§å¢é•¿é¿å…æ‹¥å¡
3. å¿«é€Ÿé‡ä¼ ï¼šæ”¶åˆ°3ä¸ªé‡å¤ACKç«‹å³é‡ä¼ ï¼Œä¸ç­‰è¶…æ—¶
4. å¿«é€Ÿæ¢å¤ï¼šä¸¢åŒ…åä¸å›åˆ°æ…¢å¯åŠ¨ï¼Œå¿«é€Ÿæ¢å¤åˆ°æ‹¥å¡é¿å…
5. è¶…æ—¶ï¼šä¸¥é‡æ‹¥å¡ï¼Œé‡æ–°æ…¢å¯åŠ¨

ç®—æ³•æ¼”è¿›ï¼š
Tahoe â†’ Reno â†’ NewReno â†’ CUBIC â†’ BBR

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")


if __name__ == "__main__":
    main()
