# ç¬¬5å¤©ï¼šç½‘ç»œå‘½ä»¤å…¥é—¨ - ping

> "pingä¸€ä¸‹ï¼Œç½‘ç»œé€šä¸é€šç«‹åˆ»çŸ¥é“ã€‚"

## ğŸ“š ä»Šæ—¥ç›®æ ‡

- ç†è§£pingå‘½ä»¤çš„å·¥ä½œåŸç†
- æŒæ¡ICMPåè®®åŸºç¡€çŸ¥è¯†
- å­¦ä¼šä½¿ç”¨pingå‘½ä»¤è¿›è¡Œç½‘ç»œè¯Šæ–­
- ç¼–å†™è‡ªå·±çš„pingå·¥å…·

## ğŸ¯ ä»€ä¹ˆæ˜¯pingï¼Ÿ

### ç”Ÿæ´»ä¸­çš„ä¾‹å­

```
ping = å–Šè¯æ¸¸æˆ

ä½ ï¼šå–‚ï¼èƒ½å¬åˆ°å—ï¼Ÿ ï¼ˆå‘é€ï¼‰
æœ‹å‹ï¼šèƒ½å¬åˆ°ï¼         ï¼ˆå›åº”ï¼‰
ä½ ï¼šå¤ªå¥½äº†ï¼Œé€šä¿¡æ­£å¸¸ï¼ ï¼ˆç¡®è®¤ï¼‰
```

**pingå‘½ä»¤**å°±æ˜¯ç”¨æ¥æµ‹è¯•ç½‘ç»œè¿é€šæ€§çš„å·¥å…·ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªæ•°æ®åŒ…åˆ°ç›®æ ‡ä¸»æœºï¼Œç„¶åç­‰å¾…å›åº”ã€‚

### pingçš„ä½œç”¨

1. **æµ‹è¯•è¿é€šæ€§**ï¼šç›®æ ‡ä¸»æœºæ˜¯å¦å¯è¾¾
2. **æµ‹é‡å»¶è¿Ÿ**ï¼šæ•°æ®å¾€è¿”éœ€è¦å¤šå°‘æ—¶é—´
3. **æ£€æµ‹ä¸¢åŒ…**ï¼šæœ‰å¤šå°‘æ•°æ®åŒ…ä¸¢å¤±äº†
4. **è¯Šæ–­ç½‘ç»œé—®é¢˜**ï¼šå®šä½ç½‘ç»œæ•…éšœ

## ğŸ“¡ ICMPåè®®

### ä»€ä¹ˆæ˜¯ICMPï¼Ÿ

**ICMP**ï¼ˆInternet Control Message Protocolï¼Œäº’è”ç½‘æ§åˆ¶æ¶ˆæ¯åè®®ï¼‰æ˜¯TCP/IPåè®®æ—çš„ä¸€éƒ¨åˆ†ï¼Œå·¥ä½œåœ¨ç½‘é™…å±‚ï¼ˆIPå±‚ï¼‰ã€‚

### ICMPçš„ä½œç”¨

```
ICMP = ç½‘ç»œçš„"é€šè®¯å‘˜"

ä¸»è¦ä»»åŠ¡ï¼š
1. æŠ¥å‘Šé”™è¯¯ï¼ˆ"å¯¹æ–¹ä¸åœ¨å®¶"ï¼‰
2. è¯Šæ–­é—®é¢˜ï¼ˆ"pingæµ‹è¯•"ï¼‰
3. æä¾›åé¦ˆï¼ˆ"è¶…æ—¶äº†"ï¼‰
```

### å¸¸è§çš„ICMPæ¶ˆæ¯ç±»å‹

| ç±»å‹ | åç§° | ç”¨é€” |
|------|------|------|
| 0 | Echo Reply | pingçš„å›åº” |
| 3 | Destination Unreachable | ç›®æ ‡ä¸å¯è¾¾ |
| 5 | Redirect | é‡å®šå‘ |
| 8 | Echo Request | pingçš„è¯·æ±‚ |
| 11 | Time Exceeded | è¶…æ—¶ï¼ˆTTL=0ï¼‰ |

## ğŸ” pingçš„å·¥ä½œåŸç†

### å®Œæ•´æµç¨‹

```
1. å‘é€ ICMP Echo Requestï¼ˆç±»å‹8ï¼‰
   ä½ çš„ç”µè„‘ â†’ ç›®æ ‡ä¸»æœº
   "ä½ å¥½ï¼Œæˆ‘æ˜¯192.168.1.100ï¼Œè¯·å›åº”ï¼"

2. æ¥æ”¶ ICMP Echo Replyï¼ˆç±»å‹0ï¼‰
   ç›®æ ‡ä¸»æœº â†’ ä½ çš„ç”µè„‘
   "æ”¶åˆ°ï¼æˆ‘æ˜¯8.8.8.8ï¼Œä¸€åˆ‡æ­£å¸¸ï¼"

3. è®¡ç®—RTTï¼ˆå¾€è¿”æ—¶é—´ï¼‰
   å‘é€æ—¶é—´ï¼š10:00:00.000
   æ¥æ”¶æ—¶é—´ï¼š10:00:00.050
   RTT = 50æ¯«ç§’
```

### RTTï¼ˆRound-Trip Timeï¼‰

**RTT**ï¼šæ•°æ®åŒ…ä»å‘é€åˆ°æ”¶åˆ°å›å¤çš„æ€»æ—¶é—´

```
RTT = å»ç¨‹æ—¶é—´ + å›ç¨‹æ—¶é—´

å½±å“RTTçš„å› ç´ ï¼š
- ç‰©ç†è·ç¦»ï¼ˆå…‰é€Ÿæ˜¯æœ‰é™çš„ï¼‰
- ç½‘ç»œæ‹¥å¡
- è·¯ç”±å™¨å¤„ç†æ—¶é—´
- å¯¹æ–¹æœåŠ¡å™¨å¤„ç†æ—¶é—´
```

### ICMPæŠ¥æ–‡ç»“æ„

```
ICMP Echo Request/Reply æ ¼å¼ï¼š

0               8              16              24              31
+---------------+---------------+---------------+---------------+
|     ç±»å‹      |     ä»£ç       |           æ ¡éªŒå’Œ              |
|   (Type)      |   (Code)      |         (Checksum)            |
+---------------+---------------+---------------+---------------+
|          æ ‡è¯†ç¬¦ (Identifier)   |      åºåˆ—å· (Sequence)        |
+---------------+---------------+---------------+---------------+
|                         æ•°æ® (Data)                            |
|                         å¯é€‰ï¼Œç”¨äºå¡«å……                         |
+---------------+---------------+---------------+---------------+

å­—æ®µè¯´æ˜ï¼š
- ç±»å‹ï¼š8=è¯·æ±‚ï¼Œ0=å›åº”
- ä»£ç ï¼šé€šå¸¸ä¸º0
- æ ¡éªŒå’Œï¼šç”¨äºæ£€æµ‹æ•°æ®å®Œæ•´æ€§
- æ ‡è¯†ç¬¦ï¼šæ ‡è¯†è¿™ä¸ªpingè¿›ç¨‹
- åºåˆ—å·ï¼šæ ‡è¯†è¿™æ˜¯ç¬¬å‡ ä¸ªåŒ…
- æ•°æ®ï¼šå¯é€‰çš„è´Ÿè½½æ•°æ®
```

## ğŸ”§ ä½¿ç”¨pingå‘½ä»¤

### åŸºæœ¬ç”¨æ³•

**Windows**ï¼š
```bash
# åŸºæœ¬ping
ping baidu.com

# ping 4æ¬¡ååœæ­¢
ping -n 4 baidu.com

# æŒ‡å®šåŒ…å¤§å°ï¼ˆå­—èŠ‚ï¼‰
ping -l 1000 baidu.com

# æŒç»­ping
ping -t baidu.com
```

**Linux/Mac**ï¼š
```bash
# åŸºæœ¬ping
ping baidu.com

# ping 4æ¬¡ååœæ­¢
ping -c 4 baidu.com

# æŒ‡å®šåŒ…å¤§å°ï¼ˆå­—èŠ‚ï¼‰
ping -s 1000 baidu.com

# å¿«é€Ÿpingï¼ˆé—´éš”0.2ç§’ï¼‰
ping -i 0.2 baidu.com
```

### è¾“å‡ºè§£æ

```bash
$ ping baidu.com

PING baidu.com (220.181.38.148): 56 data bytes
64 bytes from 220.181.38.148: icmp_seq=0 ttl=52 time=28.5 ms
64 bytes from 220.181.38.148: icmp_seq=1 ttl=52 time=27.8 ms
64 bytes from 220.181.38.148: icmp_seq=2 ttl=52 time=28.1 ms
64 bytes from 220.181.38.148: icmp_seq=3 ttl=52 time=29.2 ms

--- baidu.com ping statistics ---
4 packets transmitted, 4 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 27.8/28.4/29.2/0.5 ms
```

**å­—æ®µå«ä¹‰**ï¼š
- `64 bytes`ï¼šæ•°æ®åŒ…å¤§å°
- `icmp_seq`ï¼šåºåˆ—å·ï¼ˆç¬¬å‡ ä¸ªåŒ…ï¼‰
- `ttl=52`ï¼šç”Ÿå­˜æ—¶é—´ï¼ˆç»è¿‡äº†64-52=12ä¸ªè·¯ç”±å™¨ï¼‰
- `time=28.5 ms`ï¼šRTTå¾€è¿”æ—¶é—´
- `0.0% packet loss`ï¼šä¸¢åŒ…ç‡
- `min/avg/max`ï¼šæœ€å°/å¹³å‡/æœ€å¤§RTT

## ğŸ”§ å®æˆ˜é¡¹ç›®ï¼šå®ç°ç®€æ˜“pingå·¥å…·

è®©æˆ‘ä»¬ç”¨Pythonå®ç°ä¸€ä¸ªç®€å•çš„pingå·¥å…·ï¼

### ä»£ç å®ç°

```python
# day05_simple_ping.py
# åŠŸèƒ½ï¼šå®ç°ç®€å•çš„pingå·¥å…·

import socket
import struct
import time
import sys

def calculate_checksum(data):
    """
    è®¡ç®—ICMPæ ¡éªŒå’Œ

    å‚æ•°ï¼š
        data: è¦è®¡ç®—æ ¡éªŒå’Œçš„æ•°æ®ï¼ˆbytesï¼‰

    è¿”å›ï¼š
        æ ¡éªŒå’Œï¼ˆintï¼‰

    å·¥ä½œåŸç†ï¼š
        1. å°†æ•°æ®æŒ‰16ä½åˆ†ç»„æ±‚å’Œ
        2. å¦‚æœæœ‰è¿›ä½ï¼Œå°†è¿›ä½åŠ åˆ°ç»“æœä¸Š
        3. å–åç å¾—åˆ°æ ¡éªŒå’Œ
    """
    # å¦‚æœæ•°æ®é•¿åº¦æ˜¯å¥‡æ•°ï¼Œè¡¥ä¸€ä¸ªå­—èŠ‚0
    if len(data) % 2 != 0:
        data += b'\x00'

    # æŒ‰16ä½ï¼ˆ2å­—èŠ‚ï¼‰åˆ†ç»„æ±‚å’Œ
    checksum = 0
    for i in range(0, len(data), 2):
        # å°†ä¸¤ä¸ªå­—èŠ‚ç»„åˆæˆä¸€ä¸ª16ä½æ•´æ•°
        word = (data[i] << 8) + data[i + 1]
        checksum += word

    # å¤„ç†è¿›ä½ï¼šå°†é«˜16ä½åŠ åˆ°ä½16ä½
    while checksum >> 16:
        checksum = (checksum & 0xFFFF) + (checksum >> 16)

    # å–åç 
    checksum = ~checksum & 0xFFFF

    return checksum

def create_icmp_packet(packet_id, sequence):
    """
    åˆ›å»ºICMP Echo Requestæ•°æ®åŒ…

    å‚æ•°ï¼š
        packet_id: æ ‡è¯†ç¬¦ï¼ˆç”¨äºåŒºåˆ†ä¸åŒçš„pingè¿›ç¨‹ï¼‰
        sequence: åºåˆ—å·ï¼ˆæ ‡è¯†ç¬¬å‡ ä¸ªåŒ…ï¼‰

    è¿”å›ï¼š
        å®Œæ•´çš„ICMPæ•°æ®åŒ…ï¼ˆbytesï¼‰

    ICMPåŒ…ç»“æ„ï¼š
        [ç±»å‹(1å­—èŠ‚) | ä»£ç (1å­—èŠ‚) | æ ¡éªŒå’Œ(2å­—èŠ‚) |
         æ ‡è¯†ç¬¦(2å­—èŠ‚) | åºåˆ—å·(2å­—èŠ‚) | æ•°æ®]
    """
    # ICMPç±»å‹ï¼š8=Echo Request
    icmp_type = 8
    # ICMPä»£ç ï¼š0
    icmp_code = 0
    # æ ¡éªŒå’Œï¼šå…ˆè®¾ä¸º0ï¼Œç¨åè®¡ç®—
    icmp_checksum = 0

    # æ‰“åŒ…ICMPå¤´éƒ¨ï¼ˆä¸åŒ…æ‹¬æ ¡éªŒå’Œï¼‰
    # ! = ç½‘ç»œå­—èŠ‚åºï¼ˆå¤§ç«¯ï¼‰
    # B = unsigned char (1å­—èŠ‚)
    # H = unsigned short (2å­—èŠ‚)
    header = struct.pack('!BBHHH', icmp_type, icmp_code, icmp_checksum,
                         packet_id, sequence)

    # æ•°æ®éƒ¨åˆ†ï¼šå‘é€æ—¶é—´æˆ³ï¼ˆç”¨äºè®¡ç®—RTTï¼‰
    data = struct.pack('!d', time.time())

    # è®¡ç®—æ ¡éªŒå’Œ
    icmp_checksum = calculate_checksum(header + data)

    # é‡æ–°æ‰“åŒ…ï¼ŒåŠ å…¥æ­£ç¡®çš„æ ¡éªŒå’Œ
    header = struct.pack('!BBHHH', icmp_type, icmp_code, icmp_checksum,
                         packet_id, sequence)

    return header + data

def parse_icmp_reply(packet):
    """
    è§£æICMP Echo Replyæ•°æ®åŒ…

    å‚æ•°ï¼š
        packet: æ¥æ”¶åˆ°çš„æ•°æ®åŒ…

    è¿”å›ï¼š
        (icmp_type, icmp_code, icmp_id, icmp_seq, send_time)
    """
    # IPå¤´éƒ¨é€šå¸¸æ˜¯20å­—èŠ‚ï¼ŒICMPä»ç¬¬21å­—èŠ‚å¼€å§‹
    icmp_header = packet[20:28]

    # è§£æICMPå¤´éƒ¨
    icmp_type, icmp_code, checksum, packet_id, sequence = struct.unpack(
        '!BBHHH', icmp_header
    )

    # è§£ææ•°æ®éƒ¨åˆ†çš„æ—¶é—´æˆ³
    send_time = struct.unpack('!d', packet[28:36])[0]

    return icmp_type, icmp_code, packet_id, sequence, send_time

def ping(host, count=4, timeout=3):
    """
    pingæŒ‡å®šä¸»æœº

    å‚æ•°ï¼š
        host: ç›®æ ‡ä¸»æœºåæˆ–IPåœ°å€
        count: pingçš„æ¬¡æ•°
        timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

    è¿”å›ï¼š
        ç»Ÿè®¡ä¿¡æ¯å­—å…¸
    """
    print(f"PING {host}")
    print()

    # è§£æä¸»æœºåä¸ºIPåœ°å€
    try:
        dest_ip = socket.gethostbyname(host)
        print(f"ç›®æ ‡IP: {dest_ip}")
        print("-" * 60)
    except socket.gaierror:
        print(f"âŒ æ— æ³•è§£æä¸»æœºå: {host}")
        return None

    # åˆ›å»ºåŸå§‹socketï¼ˆéœ€è¦rootæƒé™ï¼‰
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)
        sock.settimeout(timeout)
    except PermissionError:
        print("âŒ éœ€è¦ç®¡ç†å‘˜æƒé™è¿è¡Œæ­¤ç¨‹åº")
        print("ğŸ’¡ Linux/Mac: sudo python day05_simple_ping.py")
        print("ğŸ’¡ Windows: ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ")
        return None

    # ç»Ÿè®¡ä¿¡æ¯
    packet_id = 12345  # å¯ä»¥ç”¨è¿›ç¨‹ID
    sent = 0
    received = 0
    rtt_list = []

    # å‘é€pingåŒ…
    for seq in range(count):
        try:
            # åˆ›å»ºICMPåŒ…
            packet = create_icmp_packet(packet_id, seq)

            # å‘é€
            send_time = time.time()
            sock.sendto(packet, (dest_ip, 0))
            sent += 1

            # æ¥æ”¶å›å¤
            try:
                reply_packet, addr = sock.recvfrom(1024)
                recv_time = time.time()

                # è§£æå›å¤
                icmp_type, icmp_code, reply_id, reply_seq, packet_send_time = \
                    parse_icmp_reply(reply_packet)

                # æ£€æŸ¥æ˜¯å¦æ˜¯æˆ‘ä»¬çš„åŒ…çš„å›å¤
                if icmp_type == 0 and reply_id == packet_id and reply_seq == seq:
                    # è®¡ç®—RTT
                    rtt = (recv_time - packet_send_time) * 1000  # è½¬æ¢ä¸ºæ¯«ç§’
                    rtt_list.append(rtt)
                    received += 1

                    # è·å–TTL
                    ttl = struct.unpack('!B', reply_packet[8:9])[0]

                    print(f"âœ… æ¥è‡ª {dest_ip}: icmp_seq={seq} ttl={ttl} "
                          f"time={rtt:.2f} ms")
                else:
                    print(f"âš ï¸  æ”¶åˆ°æ„å¤–çš„ICMPåŒ… type={icmp_type}")

            except socket.timeout:
                print(f"â±ï¸  icmp_seq={seq} è¯·æ±‚è¶…æ—¶")

            # ç­‰å¾…1ç§’å†å‘é€ä¸‹ä¸€ä¸ªåŒ…
            if seq < count - 1:
                time.sleep(1)

        except Exception as e:
            print(f"âŒ å‘é€å¤±è´¥: {e}")

    sock.close()

    # æ‰“å°ç»Ÿè®¡ä¿¡æ¯
    print()
    print("-" * 60)
    print(f"ğŸ“Š {host} pingç»Ÿè®¡ä¿¡æ¯:")
    print(f"   å‘é€: {sent} ä¸ªåŒ…")
    print(f"   æ¥æ”¶: {received} ä¸ªåŒ…")
    print(f"   ä¸¢å¤±: {sent - received} ä¸ªåŒ… ({((sent-received)/sent*100):.1f}% loss)")

    if rtt_list:
        print(f"   RTT: æœ€å°={min(rtt_list):.2f}ms, "
              f"å¹³å‡={sum(rtt_list)/len(rtt_list):.2f}ms, "
              f"æœ€å¤§={max(rtt_list):.2f}ms")
    print("-" * 60)

    return {
        'sent': sent,
        'received': received,
        'rtt_list': rtt_list
    }

def main():
    """
    ä¸»å‡½æ•°
    """
    print("=" * 60)
    print("ç®€æ˜“Pingå·¥å…·".center(60))
    print("=" * 60)
    print()

    # è·å–ç›®æ ‡ä¸»æœº
    if len(sys.argv) > 1:
        host = sys.argv[1]
    else:
        host = input("è¯·è¾“å…¥è¦pingçš„ä¸»æœºåæˆ–IP: ").strip()
        if not host:
            host = "baidu.com"  # é»˜è®¤

    # æ‰§è¡Œping
    result = ping(host, count=4, timeout=3)

    if result and result['received'] > 0:
        print()
        print("ğŸ‰ Pingå®Œæˆï¼")
    else:
        print()
        print("âŒ Pingå¤±è´¥æˆ–ç½‘ç»œä¸å¯è¾¾")

if __name__ == "__main__":
    main()
```

### è¿è¡Œç¨‹åº

```bash
# Linux/Macï¼ˆéœ€è¦rootæƒé™ï¼‰
sudo python code/day05/day05_simple_ping.py baidu.com

# Windowsï¼ˆä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œï¼‰
python code\day05\day05_simple_ping.py baidu.com

# ä¸å¸¦å‚æ•°è¿è¡Œï¼Œä¼šæç¤ºè¾“å…¥ä¸»æœºå
sudo python code/day05/day05_simple_ping.py
```

### é¢„æœŸè¾“å‡º

```
============================================================
                       ç®€æ˜“Pingå·¥å…·
============================================================

PING baidu.com

ç›®æ ‡IP: 220.181.38.148
------------------------------------------------------------
âœ… æ¥è‡ª 220.181.38.148: icmp_seq=0 ttl=52 time=28.50 ms
âœ… æ¥è‡ª 220.181.38.148: icmp_seq=1 ttl=52 time=27.82 ms
âœ… æ¥è‡ª 220.181.38.148: icmp_seq=2 ttl=52 time=28.15 ms
âœ… æ¥è‡ª 220.181.38.148: icmp_seq=3 ttl=52 time=29.20 ms

------------------------------------------------------------
ğŸ“Š baidu.com pingç»Ÿè®¡ä¿¡æ¯:
   å‘é€: 4 ä¸ªåŒ…
   æ¥æ”¶: 4 ä¸ªåŒ…
   ä¸¢å¤±: 0 ä¸ªåŒ… (0.0% loss)
   RTT: æœ€å°=27.82ms, å¹³å‡=28.42ms, æœ€å¤§=29.20ms
------------------------------------------------------------

ğŸ‰ Pingå®Œæˆï¼
```

## ğŸ” ä»£ç è¯¦è§£

### 1. ä¸ºä»€ä¹ˆéœ€è¦rootæƒé™ï¼Ÿ

```python
sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)
```

**åŸå§‹å¥—æ¥å­—**ï¼ˆSOCK_RAWï¼‰å¯ä»¥æ„é€ ä»»æ„çš„IPåŒ…ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿè¦æ±‚å¿…é¡»æœ‰ç®¡ç†å‘˜æƒé™æ‰èƒ½ä½¿ç”¨ã€‚

### 2. æ ¡éªŒå’Œçš„è®¡ç®—

æ ¡éªŒå’Œç”¨äºæ£€æµ‹æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦æŸåï¼š

```python
# åŸç†ï¼š
1. å°†æ•°æ®æŒ‰16ä½åˆ†ç»„
2. æ‰€æœ‰åˆ†ç»„ç›¸åŠ 
3. å¦‚æœæœ‰è¿›ä½ï¼ŒåŠ åˆ°ä½16ä½
4. å¯¹ç»“æœå–åç 

# æ¥æ”¶æ–¹éªŒè¯ï¼š
1. å¯¹æ”¶åˆ°çš„æ•°æ®ï¼ˆåŒ…æ‹¬æ ¡éªŒå’Œï¼‰åšåŒæ ·çš„è®¡ç®—
2. å¦‚æœç»“æœæ˜¯0xFFFFï¼Œè¯´æ˜æ•°æ®å®Œæ•´
3. å¦åˆ™è¯´æ˜æ•°æ®æŸå
```

### 3. TTLçš„å«ä¹‰

```
TTL (Time To Live) = ç”Ÿå­˜æ—¶é—´

åˆå§‹å€¼ï¼šé€šå¸¸æ˜¯64æˆ–128
æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨ï¼šTTL -= 1
å½“TTL = 0ï¼šè·¯ç”±å™¨ä¸¢å¼ƒè¯¥åŒ…ï¼Œè¿”å›è¶…æ—¶é”™è¯¯

ä½œç”¨ï¼šé˜²æ­¢æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­æ— é™å¾ªç¯
```

### 4. æ—¶é—´æˆ³çš„ä½œç”¨

```python
# å‘é€æ—¶åœ¨æ•°æ®éƒ¨åˆ†åµŒå…¥æ—¶é—´æˆ³
data = struct.pack('!d', time.time())

# æ”¶åˆ°å›å¤æ—¶ï¼Œè§£ææ—¶é—´æˆ³
send_time = struct.unpack('!d', packet[28:36])[0]

# è®¡ç®—RTT
rtt = (recv_time - send_time) * 1000  # æ¯«ç§’
```

## ğŸ“ çŸ¥è¯†å°ç»“

### ä»Šå¤©å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

1. âœ… pingç”¨äºæµ‹è¯•ç½‘ç»œè¿é€šæ€§å’Œå»¶è¿Ÿ
2. âœ… pingåŸºäºICMPåè®®ï¼ˆç±»å‹8è¯·æ±‚ï¼Œç±»å‹0å›å¤ï¼‰
3. âœ… RTTæ˜¯æ•°æ®åŒ…å¾€è¿”çš„æ€»æ—¶é—´
4. âœ… TTLè¡¨ç¤ºæ•°æ®åŒ…è¿˜èƒ½ç»è¿‡å¤šå°‘ä¸ªè·¯ç”±å™¨
5. âœ… å®ç°pingéœ€è¦ä½¿ç”¨åŸå§‹å¥—æ¥å­—

### é‡è¦æ¦‚å¿µ

| æ¦‚å¿µ | å«ä¹‰ | å•ä½ |
|------|------|------|
| RTT | å¾€è¿”æ—¶é—´ | æ¯«ç§’(ms) |
| TTL | ç”Ÿå­˜æ—¶é—´ | è·³æ•°(hops) |
| ä¸¢åŒ…ç‡ | ä¸¢å¤±çš„åŒ…å æ€»æ•°çš„æ¯”ä¾‹ | ç™¾åˆ†æ¯”(%) |
| ICMP | ç½‘ç»œæ§åˆ¶æ¶ˆæ¯åè®® | - |

### pingå‘½ä»¤é€ŸæŸ¥

```bash
# åŸºæœ¬ç”¨æ³•
ping ç›®æ ‡ä¸»æœº

# å¸¸ç”¨é€‰é¡¹
-c æ¬¡æ•°      # Linux/Mac: æŒ‡å®špingæ¬¡æ•°
-n æ¬¡æ•°      # Windows: æŒ‡å®špingæ¬¡æ•°
-i é—´éš”      # æŒ‡å®šå‘é€é—´éš”ï¼ˆç§’ï¼‰
-s å¤§å°      # æŒ‡å®šæ•°æ®åŒ…å¤§å°
-t           # Windows: æŒç»­ping
```

## ğŸ’ª ç»ƒä¹ é¢˜

### ç»ƒä¹ 1ï¼šå®é™…æ“ä½œ
ä½¿ç”¨pingå‘½ä»¤æµ‹è¯•ä»¥ä¸‹ä¸»æœºï¼Œè®°å½•RTTå’ŒTTLï¼š
1. baidu.com
2. google.com
3. ä½ çš„è·¯ç”±å™¨ï¼ˆé€šå¸¸æ˜¯192.168.1.1ï¼‰
4. æœ¬æœºï¼ˆ127.0.0.1ï¼‰

### ç»ƒä¹ 2ï¼šç†è§£TTL
å¦‚æœping baidu.comçš„TTLæ˜¯52ï¼Œåˆå§‹TTLæ˜¯64ï¼Œé—®ï¼š
1. æ•°æ®åŒ…ç»è¿‡äº†å¤šå°‘ä¸ªè·¯ç”±å™¨ï¼Ÿ
2. ä¸ºä»€ä¹ˆä¸åŒçš„ä¸»æœºTTLä¸ä¸€æ ·ï¼Ÿ

### ç»ƒä¹ 3ï¼šåˆ†æä¸¢åŒ…
å¦‚æœpingä¸€ä¸ªç½‘ç«™ï¼Œå‡ºç°ä»¥ä¸‹æƒ…å†µï¼Œå¯èƒ½çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
1. 100%ä¸¢åŒ…
2. å¶å°”ä¸¢åŒ…ï¼ˆ10-20%ï¼‰
3. RTTå¾ˆé«˜ï¼ˆ>500msï¼‰

### ç»ƒä¹ 4ï¼šä»£ç æ‰©å±•
æ‰©å±•pingå·¥å…·ï¼š
1. æ·»åŠ å›¾å½¢åŒ–çš„RTTå˜åŒ–æ˜¾ç¤º
2. æ”¯æŒpingå¤šä¸ªä¸»æœº
3. å°†ç»“æœä¿å­˜åˆ°æ–‡ä»¶
4. æ·»åŠ å£°éŸ³æç¤ºï¼ˆè¿é€šæ—¶æ’­æ”¾æç¤ºéŸ³ï¼‰

### ç»ƒä¹ 5ï¼šæ€è€ƒé¢˜
1. ä¸ºä»€ä¹ˆpingä½¿ç”¨ICMPè€Œä¸æ˜¯TCPæˆ–UDPï¼Ÿ
2. èƒ½å¦é€šè¿‡pingåˆ¤æ–­å¯¹æ–¹çš„æ“ä½œç³»ç»Ÿï¼Ÿï¼ˆæç¤ºï¼šçœ‹TTLåˆå§‹å€¼ï¼‰
3. é˜²ç«å¢™å¯ä»¥é˜»æ­¢pingå—ï¼Ÿ

## ğŸ“š æ‰©å±•é˜…è¯»

### pingçš„é«˜çº§ç”¨æ³•

**æµ‹è¯•MTUï¼ˆæœ€å¤§ä¼ è¾“å•å…ƒï¼‰**ï¼š
```bash
# Linux/Mac
ping -M do -s 1472 baidu.com

# Windows
ping -f -l 1472 baidu.com

# å¦‚æœæˆåŠŸï¼Œè¯´æ˜MTU >= 1500
# å¦‚æœå¤±è´¥ï¼Œé€æ¸å‡å°æ•°å€¼ç›´åˆ°æˆåŠŸ
```

**æ´ªæ°´pingï¼ˆå‹åŠ›æµ‹è¯•ï¼‰**ï¼š
```bash
# Linuxï¼ˆéœ€è¦rootæƒé™ï¼‰
sudo ping -f baidu.com

# è¯´æ˜ï¼šå°½å¯èƒ½å¿«åœ°å‘é€åŒ…ï¼Œç”¨äºå‹åŠ›æµ‹è¯•
# âš ï¸ æ³¨æ„ï¼šä¸è¦å¯¹å…¬å…±æœåŠ¡å™¨ä½¿ç”¨ï¼Œå¯èƒ½è¢«è§†ä¸ºæ”»å‡»
```

### ä¸åŒæ“ä½œç³»ç»Ÿçš„TTLåˆå§‹å€¼

| æ“ä½œç³»ç»Ÿ | TTLåˆå§‹å€¼ |
|----------|-----------|
| Linux | 64 |
| Windows | 128 |
| Ciscoè·¯ç”±å™¨ | 255 |
| Unix/BSD | 255 |

é€šè¿‡pingè¿”å›çš„TTLï¼Œå¯ä»¥å¤§è‡´åˆ¤æ–­å¯¹æ–¹çš„æ“ä½œç³»ç»Ÿç±»å‹ï¼

### ICMPçš„å…¶ä»–ç”¨é€”

1. **Traceroute**ï¼šé€šè¿‡é€æ­¥å¢åŠ TTLæ¥è¿½è¸ªè·¯ç”±
2. **MTUå‘ç°**ï¼šç¡®å®šæœ€ä½³æ•°æ®åŒ…å¤§å°
3. **ç½‘ç»œè¯Šæ–­**ï¼šæ£€æµ‹ç½‘ç»œé…ç½®é—®é¢˜
4. **é”™è¯¯æŠ¥å‘Š**ï¼šé€šçŸ¥æºä¸»æœºç½‘ç»œé”™è¯¯

## ğŸ¯ æ˜å¤©é¢„å‘Š

**ç¬¬6å¤©ï¼šç½‘ç»œå‘½ä»¤è¿›é˜¶ - traceroute**

æˆ‘ä»¬å°†å­¦ä¹ ï¼š
- tracerouteçš„å·¥ä½œåŸç†
- å¦‚ä½•è¿½è¸ªæ•°æ®åŒ…çš„å®Œæ•´è·¯å¾„
- ç†è§£TTLåœ¨è·¯ç”±è¿½è¸ªä¸­çš„ä½œç”¨
- ç¼–å†™è‡ªå·±çš„tracerouteå·¥å…·

---

ğŸ’¡ **ä»Šæ—¥é‡‘å¥**ï¼špingé€šç½‘ç»œï¼Œå°±åƒå¬åˆ°è¿œæ–¹æœ‹å‹çš„å›éŸ³ï¼

ğŸ‘‰ [ä¸Šä¸€å¤©ï¼šTCP/IPå››å±‚æ¨¡å‹](day04.md) | [è¿”å›ç›®å½•](../../README.md) | [ä¸‹ä¸€å¤©ï¼štracerouteè¯¦è§£](day06.md)
